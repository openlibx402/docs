
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the OpenLibx402 autonomous payments ecosystem">
      
      
      
        <link rel="canonical" href="https://openlibx402.github.io/documentation/openlibx402-technical-spec/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../quick-reference/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Technical Specification - OpenLibx402 Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#openlibx402-technical-specification" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="OpenLibx402 Docs" class="md-header__button md-logo" aria-label="OpenLibx402 Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenLibx402 Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Technical Specification
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/openlibx402/documentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Technical Specification

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../quick-reference/" class="md-tabs__link">
        
  
  
    
  
  Quick Reference

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../packages/python/openlibx402-core/" class="md-tabs__link">
          
  
  
  Packages

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../examples/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="OpenLibx402 Docs" class="md-nav__button md-logo" aria-label="OpenLibx402 Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OpenLibx402 Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openlibx402/documentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Technical Specification
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Technical Specification
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#project-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Project Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Core Principles
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Project Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-core-protocol-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      1. Core Protocol Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Core Protocol Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-core-python-openlibx402core-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-core (Python) / @openlibx402/core (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-server-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      2. Server-Side Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Server-Side Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-fastapi-python" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-fastapi (Python)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-client-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      3. Client-Side Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Client-Side Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-client-python-openlibx402client-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-client (Python) / @openlibx402/client (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-langchain-integration" class="md-nav__link">
    <span class="md-ellipsis">
      4. LangChain Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. LangChain Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-langchain-python-openlibx402langchain-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-langchain (Python) / @openlibx402/langchain (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-langgraph-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. LangGraph Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. LangGraph Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-langgraph-python-openlibx402langgraph-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-langgraph (Python) / @openlibx402/langgraph (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-error-handling-retry-logic" class="md-nav__link">
    <span class="md-ellipsis">
      6. Error Handling &amp; Retry Logic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Error Handling &amp; Retry Logic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-retry-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Retry Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-code-reference" class="md-nav__link">
    <span class="md-ellipsis">
      Error Code Reference
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-testing-development" class="md-nav__link">
    <span class="md-ellipsis">
      7. Testing &amp; Development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Testing &amp; Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      Test Utilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-test" class="md-nav__link">
    <span class="md-ellipsis">
      Example Test
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-example-implementations" class="md-nav__link">
    <span class="md-ellipsis">
      8. Example Implementations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Example Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-fastapi-server-example" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 FastAPI Server Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-langchain-agent-example" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 LangChain Agent Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-langgraph-workflow-example" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 LangGraph Workflow Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-package-metadata-publishing" class="md-nav__link">
    <span class="md-ellipsis">
      9. Package Metadata &amp; Publishing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Package Metadata &amp; Publishing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-packages-pypi" class="md-nav__link">
    <span class="md-ellipsis">
      Python Packages (PyPI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typescript-packages-npm" class="md-nav__link">
    <span class="md-ellipsis">
      TypeScript Packages (npm)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-documentation-structure" class="md-nav__link">
    <span class="md-ellipsis">
      10. Documentation Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-development-roadmap" class="md-nav__link">
    <span class="md-ellipsis">
      11. Development Roadmap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Development Roadmap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-core-fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Core &amp; FastAPI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-ai-agent-integrations" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: AI Agent Integrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-additional-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Additional Frameworks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-enhanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Enhanced Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-5-ecosystem" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 5: Ecosystem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      12. Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wallet-security" class="md-nav__link">
    <span class="md-ellipsis">
      Wallet Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-security" class="md-nav__link">
    <span class="md-ellipsis">
      API Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      13. Performance Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13. Performance Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-side" class="md-nav__link">
    <span class="md-ellipsis">
      Client-Side
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-side" class="md-nav__link">
    <span class="md-ellipsis">
      Server-Side
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-monitoring-observability" class="md-nav__link">
    <span class="md-ellipsis">
      14. Monitoring &amp; Observability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14. Monitoring &amp; Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metrics-to-track" class="md-nav__link">
    <span class="md-ellipsis">
      Metrics to Track
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-of-technical-specification" class="md-nav__link">
    <span class="md-ellipsis">
      End of Technical Specification
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Reference
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Packages
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Packages
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/python/openlibx402-core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/python/openlibx402-fastapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FastAPI Integration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/python/openlibx402-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Client Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/python/openlibx402-langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangChain Integration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/python/openlibx402-langgraph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangGraph Integration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    TypeScript
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            TypeScript
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/typescript/openlibx402-core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/typescript/openlibx402-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Client SDK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/typescript/openlibx402-express/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Express Middleware
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/typescript/openlibx402-langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangChain Integration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../packages/typescript/openlibx402-langgraph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangGraph Integration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/python/fastapi-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FastAPI Server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/python/langchain-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangChain Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/python/langgraph-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangGraph Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    TypeScript
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            TypeScript
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/typescript/express-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Express Server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/typescript/langchain-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangChain Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/typescript/langgraph-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LangGraph Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#project-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Project Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Core Principles
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Project Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-core-protocol-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      1. Core Protocol Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Core Protocol Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-core-python-openlibx402core-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-core (Python) / @openlibx402/core (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-server-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      2. Server-Side Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Server-Side Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-fastapi-python" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-fastapi (Python)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-client-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      3. Client-Side Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Client-Side Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-client-python-openlibx402client-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-client (Python) / @openlibx402/client (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-langchain-integration" class="md-nav__link">
    <span class="md-ellipsis">
      4. LangChain Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. LangChain Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-langchain-python-openlibx402langchain-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-langchain (Python) / @openlibx402/langchain (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-langgraph-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. LangGraph Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. LangGraph Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#package-openlibx402-langgraph-python-openlibx402langgraph-typescript" class="md-nav__link">
    <span class="md-ellipsis">
      Package: openlibx402-langgraph (Python) / @openlibx402/langgraph (TypeScript)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-error-handling-retry-logic" class="md-nav__link">
    <span class="md-ellipsis">
      6. Error Handling &amp; Retry Logic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Error Handling &amp; Retry Logic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-retry-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Automatic Retry Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-code-reference" class="md-nav__link">
    <span class="md-ellipsis">
      Error Code Reference
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-testing-development" class="md-nav__link">
    <span class="md-ellipsis">
      7. Testing &amp; Development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Testing &amp; Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      Test Utilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-test" class="md-nav__link">
    <span class="md-ellipsis">
      Example Test
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-example-implementations" class="md-nav__link">
    <span class="md-ellipsis">
      8. Example Implementations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Example Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-fastapi-server-example" class="md-nav__link">
    <span class="md-ellipsis">
      8.1 FastAPI Server Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-langchain-agent-example" class="md-nav__link">
    <span class="md-ellipsis">
      8.2 LangChain Agent Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-langgraph-workflow-example" class="md-nav__link">
    <span class="md-ellipsis">
      8.3 LangGraph Workflow Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-package-metadata-publishing" class="md-nav__link">
    <span class="md-ellipsis">
      9. Package Metadata &amp; Publishing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Package Metadata &amp; Publishing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python-packages-pypi" class="md-nav__link">
    <span class="md-ellipsis">
      Python Packages (PyPI)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typescript-packages-npm" class="md-nav__link">
    <span class="md-ellipsis">
      TypeScript Packages (npm)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-documentation-structure" class="md-nav__link">
    <span class="md-ellipsis">
      10. Documentation Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-development-roadmap" class="md-nav__link">
    <span class="md-ellipsis">
      11. Development Roadmap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Development Roadmap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-core-fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Core &amp; FastAPI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-ai-agent-integrations" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: AI Agent Integrations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-additional-frameworks" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Additional Frameworks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-enhanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Enhanced Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-5-ecosystem" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 5: Ecosystem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      12. Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wallet-security" class="md-nav__link">
    <span class="md-ellipsis">
      Wallet Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Verification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-security" class="md-nav__link">
    <span class="md-ellipsis">
      API Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      13. Performance Optimization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13. Performance Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-side" class="md-nav__link">
    <span class="md-ellipsis">
      Client-Side
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-side" class="md-nav__link">
    <span class="md-ellipsis">
      Server-Side
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-monitoring-observability" class="md-nav__link">
    <span class="md-ellipsis">
      14. Monitoring &amp; Observability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14. Monitoring &amp; Observability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metrics-to-track" class="md-nav__link">
    <span class="md-ellipsis">
      Metrics to Track
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      Logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-of-technical-specification" class="md-nav__link">
    <span class="md-ellipsis">
      End of Technical Specification
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/openlibx402/documentation/edit/master/docs/openlibx402-technical-spec.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="openlibx402-technical-specification">OpenLibx402 Technical Specification<a class="headerlink" href="#openlibx402-technical-specification" title="Permanent link">&para;</a></h1>
<h2 id="project-overview">Project Overview<a class="headerlink" href="#project-overview" title="Permanent link">&para;</a></h2>
<p>OpenLibx402 is a library ecosystem that implements the X402 protocol for enabling autonomous, frictionless payments in AI agents and web APIs. The protocol leverages HTTP 402 "Payment Required" status code and Solana blockchain for instant, low-cost transactions.</p>
<h2 id="core-principles">Core Principles<a class="headerlink" href="#core-principles" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>Machine-Native Payments</strong>: Enable AI agents to autonomously pay for API access without human intervention</li>
<li><strong>Pay-Per-Use</strong>: Support micropayments with near-zero transaction costs</li>
<li><strong>Developer-Friendly</strong>: Simple integration with one-line middleware</li>
<li><strong>Blockchain-Agnostic Design</strong>: Start with Solana, architect for future chain support</li>
<li><strong>Dual API Approach</strong>: Support both explicit and implicit payment handling</li>
</ol>
<hr />
<h2 id="project-structure">Project Structure<a class="headerlink" href="#project-structure" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>openlibx402/
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>├── packages/
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>│   ├── core/                      # Core protocol implementation
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>│   │   ├── python/
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>│   │   │   └── openlibx402-core/
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>│   │   └── typescript/
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>│   │       └── @openlibx402/core
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>│   │
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>│   ├── server/                    # Server-side libraries
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>│   │   ├── python/
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>│   │   │   └── openlibx402-fastapi/
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>│   │   └── typescript/
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>│   │       ├── @openlibx402/express
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>│   │       ├── @openlibx402/nextjs
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>│   │       └── @openlibx402/hono
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>│   │
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>│   ├── client/                    # Client-side libraries
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>│   │   ├── python/
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>│   │   │   └── openlibx402-client/
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>│   │   └── typescript/
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>│   │       └── @openlibx402/client
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>│   │
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>│   └── integrations/              # Framework integrations
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>│       ├── python/
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>│       │   ├── openlibx402-langchain/
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>│       │   └── openlibx402-langgraph/
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>│       └── typescript/
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>│           ├── @openlibx402/langchain
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>│           └── @openlibx402/langgraph
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>│
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>├── examples/                      # Example implementations
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>│   ├── fastapi-server/
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>│   ├── langchain-agent/
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>│   ├── langgraph-workflow/
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>│   └── fullstack-demo/
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>│
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>└── docs/
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    ├── getting-started.md
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    ├── api-reference.md
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    └── integration-guides/
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="1-core-protocol-implementation">1. Core Protocol Implementation<a class="headerlink" href="#1-core-protocol-implementation" title="Permanent link">&para;</a></h2>
<h3 id="package-openlibx402-core-python-openlibx402core-typescript">Package: <code>openlibx402-core</code> (Python) / <code>@openlibx402/core</code> (TypeScript)<a class="headerlink" href="#package-openlibx402-core-python-openlibx402core-typescript" title="Permanent link">&para;</a></h3>
<h4 id="purpose">Purpose<a class="headerlink" href="#purpose" title="Permanent link">&para;</a></h4>
<p>Core protocol logic for X402 payment flow, independent of any framework.</p>
<h4 id="key-components">Key Components<a class="headerlink" href="#key-components" title="Permanent link">&para;</a></h4>
<h5 id="11-payment-request-structure">1.1 Payment Request Structure<a class="headerlink" href="#11-payment-request-structure" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Python</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="nd">@dataclass</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentRequest</span><span class="p">:</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an X402 payment request (402 response)&quot;&quot;&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="n">max_amount_required</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># Amount in token units (e.g., &quot;0.10&quot;)</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>    <span class="n">asset_type</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># &quot;SPL&quot; for Solana tokens</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span class="n">asset_address</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># Token mint address</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># Recipient&#39;s wallet address</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span>                       <span class="c1"># &quot;solana-devnet&quot; | &quot;solana-mainnet&quot;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>    <span class="n">expires_at</span><span class="p">:</span> <span class="n">datetime</span>               <span class="c1"># Expiration timestamp</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>    <span class="n">nonce</span><span class="p">:</span> <span class="nb">str</span>                         <span class="c1"># Unique identifier for replay protection</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># Unique payment request ID</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span>                      <span class="c1"># API endpoint being accessed</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Human-readable description</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to JSON-serializable dict&quot;&quot;&quot;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="k">pass</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;PaymentRequest&#39;</span><span class="p">:</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse from 402 response JSON&quot;&quot;&quot;</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="k">pass</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if payment request has expired&quot;&quot;&quot;</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// TypeScript</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PaymentRequest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="nx">maxAmountRequired</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">  </span><span class="nx">assetType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="nx">assetAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="nx">paymentAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="nx">network</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="nx">expiresAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="nx">nonce</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="nx">paymentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="nx">resource</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="nx">description?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="p">}</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PaymentRequestParser</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">Response</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PaymentRequest</span><span class="p">;</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">isExpired</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h5 id="12-payment-authorization">1.2 Payment Authorization<a class="headerlink" href="#12-payment-authorization" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentAuthorization</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Signed payment authorization to be sent with retry request&quot;&quot;&quot;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># From payment request</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="n">actual_amount</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># Amount being paid (≤ max_amount_required)</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span>               <span class="c1"># Recipient address</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="n">asset_address</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># Token mint address</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span>                       <span class="c1"># Blockchain network</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>                <span class="c1"># Authorization timestamp</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="n">signature</span><span class="p">:</span> <span class="nb">str</span>                     <span class="c1"># Solana signature</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="n">public_key</span><span class="p">:</span> <span class="nb">str</span>                    <span class="c1"># Payer&#39;s public key</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="n">transaction_hash</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>    <span class="c1"># On-chain tx hash (after broadcast)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_header_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode as X-Payment-Authorization header value&quot;&quot;&quot;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="k">pass</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_header</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">header_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;PaymentAuthorization&#39;</span><span class="p">:</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse from request header&quot;&quot;&quot;</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PaymentAuthorization</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nx">paymentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nx">actualAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nx">paymentAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nx">assetAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nx">network</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nx">signature</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="nx">publicKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">  </span><span class="nx">transactionHash?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="p">}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PaymentAuthorizationHandler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">toHeader</span><span class="p">(</span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentAuthorization</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">fromHeader</span><span class="p">(</span><span class="nx">headerValue</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PaymentAuthorization</span><span class="p">;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">verify</span><span class="p">(</span><span class="nx">auth</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentAuthorization</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h5 id="13-solana-integration">1.3 Solana Integration<a class="headerlink" href="#13-solana-integration" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span>
<span class="normal"><a href="#__codelineno-5-45">45</a></span>
<span class="normal"><a href="#__codelineno-5-46">46</a></span>
<span class="normal"><a href="#__codelineno-5-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solana.rpc.async_api</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solana.transaction</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transaction</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solders.keypair</span><span class="w"> </span><span class="kn">import</span> <span class="n">Keypair</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solders.pubkey</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pubkey</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">spl.token.instructions</span><span class="w"> </span><span class="kn">import</span> <span class="n">transfer_checked</span><span class="p">,</span> <span class="n">TransferCheckedParams</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">SolanaPaymentProcessor</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles Solana blockchain operations&quot;&quot;&quot;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keypair</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Keypair</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">rpc_url</span><span class="p">)</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keypair</span> <span class="o">=</span> <span class="n">keypair</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_payment_transaction</span><span class="p">(</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="n">request</span><span class="p">:</span> <span class="n">PaymentRequest</span><span class="p">,</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>        <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="n">payer_keypair</span><span class="p">:</span> <span class="n">Keypair</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a Solana transaction for the payment&quot;&quot;&quot;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>        <span class="k">pass</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sign_and_send_transaction</span><span class="p">(</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>        <span class="n">keypair</span><span class="p">:</span> <span class="n">Keypair</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sign and broadcast transaction, return tx hash&quot;&quot;&quot;</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>        <span class="k">pass</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_transaction</span><span class="p">(</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a>        <span class="n">transaction_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>        <span class="n">expected_recipient</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a>        <span class="n">expected_amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a>        <span class="n">expected_token_mint</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify a transaction was successful and matches expectations&quot;&quot;&quot;</span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a>        <span class="k">pass</span>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_token_balance</span><span class="p">(</span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a>        <span class="n">wallet_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a>        <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get token balance for a wallet&quot;&quot;&quot;</span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Connection</span><span class="p">,</span><span class="w"> </span><span class="nx">Keypair</span><span class="p">,</span><span class="w"> </span><span class="nx">PublicKey</span><span class="p">,</span><span class="w"> </span><span class="nx">Transaction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@solana/web3.js&#39;</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getAssociatedTokenAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">createTransferCheckedInstruction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@solana/spl-token&#39;</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">SolanaPaymentProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">connection</span><span class="o">:</span><span class="w"> </span><span class="kt">Connection</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">keypair?</span><span class="o">:</span><span class="w"> </span><span class="kt">Keypair</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">rpcUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">keypair?</span><span class="o">:</span><span class="w"> </span><span class="kt">Keypair</span><span class="p">);</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">createPaymentTransaction</span><span class="p">(</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">,</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="nx">payerKeypair</span><span class="o">:</span><span class="w"> </span><span class="kt">Keypair</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Transaction</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">signAndSendTransaction</span><span class="p">(</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="nx">transaction</span><span class="o">:</span><span class="w"> </span><span class="kt">Transaction</span><span class="p">,</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="nx">keypair</span><span class="o">:</span><span class="w"> </span><span class="kt">Keypair</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">verifyTransaction</span><span class="p">(</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">    </span><span class="nx">transactionHash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="nx">expectedRecipient</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="nx">expectedAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="nx">expectedTokenMint</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">getTokenBalance</span><span class="p">(</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">    </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="nx">tokenMint</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">number</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h5 id="14-error-handling">1.4 Error Handling<a class="headerlink" href="#14-error-handling" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for X402 protocol errors&quot;&quot;&quot;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="n">code</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentRequiredError</span><span class="p">(</span><span class="n">X402Error</span><span class="p">):</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when 402 response received&quot;&quot;&quot;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;PAYMENT_REQUIRED&quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>    <span class="n">payment_request</span><span class="p">:</span> <span class="n">PaymentRequest</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentExpiredError</span><span class="p">(</span><span class="n">X402Error</span><span class="p">):</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Payment request has expired&quot;&quot;&quot;</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;PAYMENT_EXPIRED&quot;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">InsufficientFundsError</span><span class="p">(</span><span class="n">X402Error</span><span class="p">):</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wallet has insufficient funds&quot;&quot;&quot;</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;INSUFFICIENT_FUNDS&quot;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="n">required_amount</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="n">available_amount</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentVerificationError</span><span class="p">(</span><span class="n">X402Error</span><span class="p">):</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Payment verification failed&quot;&quot;&quot;</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;PAYMENT_VERIFICATION_FAILED&quot;</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="k">class</span><span class="w"> </span><span class="nc">TransactionBroadcastError</span><span class="p">(</span><span class="n">X402Error</span><span class="p">):</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Failed to broadcast transaction&quot;&quot;&quot;</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;TRANSACTION_BROADCAST_FAILED&quot;</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">InvalidPaymentRequestError</span><span class="p">(</span><span class="n">X402Error</span><span class="p">):</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Payment request format is invalid&quot;&quot;&quot;</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>    <span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;INVALID_PAYMENT_REQUEST&quot;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">);</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">}</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PaymentRequiredError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="nx">paymentRequest</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">paymentRequest</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">);</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="p">}</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PaymentExpiredError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">paymentRequest</span><span class="o">:</span><span class="w"> </span><span class="kt">PaymentRequest</span><span class="p">);</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="p">}</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">InsufficientFundsError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">  </span><span class="nx">requiredAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">  </span><span class="nx">availableAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">available</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="p">}</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PaymentVerificationError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="p">}</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">TransactionBroadcastError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="p">}</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">InvalidPaymentRequestError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">X402Error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">reason</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="2-server-side-implementation">2. Server-Side Implementation<a class="headerlink" href="#2-server-side-implementation" title="Permanent link">&para;</a></h2>
<h3 id="package-openlibx402-fastapi-python">Package: <code>openlibx402-fastapi</code> (Python)<a class="headerlink" href="#package-openlibx402-fastapi-python" title="Permanent link">&para;</a></h3>
<h4 id="purpose_1">Purpose<a class="headerlink" href="#purpose_1" title="Permanent link">&para;</a></h4>
<p>FastAPI middleware for accepting X402 payments on API endpoints.</p>
<h4 id="key-components_1">Key Components<a class="headerlink" href="#key-components_1" title="Permanent link">&para;</a></h4>
<h5 id="21-middleware">2.1 Middleware<a class="headerlink" href="#21-middleware" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span>
<span class="normal"><a href="#__codelineno-9-50">50</a></span>
<span class="normal"><a href="#__codelineno-9-51">51</a></span>
<span class="normal"><a href="#__codelineno-9-52">52</a></span>
<span class="normal"><a href="#__codelineno-9-53">53</a></span>
<span class="normal"><a href="#__codelineno-9-54">54</a></span>
<span class="normal"><a href="#__codelineno-9-55">55</a></span>
<span class="normal"><a href="#__codelineno-9-56">56</a></span>
<span class="normal"><a href="#__codelineno-9-57">57</a></span>
<span class="normal"><a href="#__codelineno-9-58">58</a></span>
<span class="normal"><a href="#__codelineno-9-59">59</a></span>
<span class="normal"><a href="#__codelineno-9-60">60</a></span>
<span class="normal"><a href="#__codelineno-9-61">61</a></span>
<span class="normal"><a href="#__codelineno-9-62">62</a></span>
<span class="normal"><a href="#__codelineno-9-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402PaymentMiddleware</span><span class="p">:</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;FastAPI middleware for X402 payment handling&quot;&quot;&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>        <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>           <span class="c1"># Recipient wallet address</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>        <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>                <span class="c1"># SPL token mint address (USDC)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>        <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;solana-devnet&quot;</span><span class="p">,</span> <span class="c1"># Network identifier</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>        <span class="n">rpc_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>            <span class="c1"># Solana RPC endpoint</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>        <span class="n">payment_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>     <span class="c1"># Payment validity in seconds</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>        <span class="n">auto_verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>       <span class="c1"># Auto-verify payments</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>    <span class="p">):</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_address</span> <span class="o">=</span> <span class="n">payment_address</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_mint</span> <span class="o">=</span> <span class="n">token_mint</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">network</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span> <span class="o">=</span> <span class="n">rpc_url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_rpc_url</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_timeout</span> <span class="o">=</span> <span class="n">payment_timeout</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auto_verify</span> <span class="o">=</span> <span class="n">auto_verify</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">SolanaPaymentProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>        <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>        <span class="n">call_next</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process request, check for payment, return 402 if needed&quot;&quot;&quot;</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a>        <span class="k">pass</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">payment_required</span><span class="p">(</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a>    <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a>    <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;solana-devnet&quot;</span><span class="p">,</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>    <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="p">):</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="sd">    Decorator for FastAPI endpoints requiring payment</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a><span class="sd">    Usage:</span>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="sd">        @app.get(&quot;/premium-data&quot;)</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a><span class="sd">        @payment_required(</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="sd">            amount=&quot;0.10&quot;,</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a><span class="sd">            payment_address=&quot;FPxxx...&quot;,</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a><span class="sd">            token_mint=&quot;USDC_MINT_ADDRESS&quot;</span>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a><span class="sd">        )</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a><span class="sd">        async def get_premium_data():</span>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="sd">            return {&quot;data&quot;: &quot;Premium content&quot;}</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a>            <span class="c1"># Check for payment authorization header</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a>            <span class="c1"># If missing, return 402 response</span>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a>            <span class="c1"># If present, verify payment</span>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a>            <span class="c1"># If valid, call original function</span>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a>            <span class="k">pass</span>
<a id="__codelineno-9-62" name="__codelineno-9-62"></a>        <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-9-63" name="__codelineno-9-63"></a>    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div></td></tr></table></div>
<h5 id="22-dependency-injection-pattern">2.2 Dependency Injection Pattern<a class="headerlink" href="#22-dependency-injection-pattern" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_payment</span><span class="p">(</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="n">required_amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PaymentAuthorization</span><span class="p">:</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="sd">    FastAPI dependency for payment verification</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="sd">    Usage:</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="sd">        @app.get(&quot;/premium-data&quot;)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="sd">        async def get_premium_data(</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="sd">            payment: PaymentAuthorization = Depends(</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="sd">                verify_payment_factory(&quot;0.10&quot;, WALLET, TOKEN)</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="sd">            )</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="sd">        ):</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="sd">            return {&quot;data&quot;: &quot;Premium content&quot;}</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>    <span class="k">pass</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">verify_payment_factory</span><span class="p">(</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>    <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>    <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;solana-devnet&quot;</span><span class="p">,</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="p">):</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating payment verification dependency&quot;&quot;&quot;</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_verify</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PaymentAuthorization</span><span class="p">:</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>        <span class="k">return</span> <span class="k">await</span> <span class="n">verify_payment</span><span class="p">(</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>            <span class="n">request</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">payment_address</span><span class="p">,</span> <span class="n">token_mint</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>        <span class="p">)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>    <span class="k">return</span> <span class="n">_verify</span>
</code></pre></div></td></tr></table></div>
<h5 id="23-configuration">2.3 Configuration<a class="headerlink" href="#23-configuration" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402Config</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Global X402 configuration&quot;&quot;&quot;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>    <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;solana-devnet&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>    <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="n">default_amount</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0.01&quot;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="n">payment_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>    <span class="n">auto_verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>        <span class="n">env_prefix</span> <span class="o">=</span> <span class="s2">&quot;X402_&quot;</span>  <span class="c1"># Load from X402_* environment variables</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="c1"># Singleton configuration</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="n">_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">X402Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">init_x402</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">X402Config</span><span class="p">):</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize global X402 configuration&quot;&quot;&quot;</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>    <span class="k">global</span> <span class="n">_config</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>    <span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">X402Config</span><span class="p">:</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get global X402 configuration&quot;&quot;&quot;</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>    <span class="k">if</span> <span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;X402 not initialized. Call init_x402() first.&quot;</span><span class="p">)</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>    <span class="k">return</span> <span class="n">_config</span>
</code></pre></div></td></tr></table></div>
<h5 id="24-response-builder">2.4 Response Builder<a class="headerlink" href="#24-response-builder" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">build_402_response</span><span class="p">(</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>    <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>    <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>    <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="n">expires_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a properly formatted 402 Payment Required response&quot;&quot;&quot;</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>    <span class="n">payment_request</span> <span class="o">=</span> <span class="n">PaymentRequest</span><span class="p">(</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="n">max_amount_required</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a>        <span class="n">asset_type</span><span class="o">=</span><span class="s2">&quot;SPL&quot;</span><span class="p">,</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a>        <span class="n">asset_address</span><span class="o">=</span><span class="n">token_mint</span><span class="p">,</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a>        <span class="n">payment_address</span><span class="o">=</span><span class="n">payment_address</span><span class="p">,</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a>        <span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a>        <span class="n">expires_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">expires_in</span><span class="p">),</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a>        <span class="n">nonce</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a>        <span class="n">payment_id</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a>        <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a>        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a>    <span class="p">)</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a>        <span class="n">status_code</span><span class="o">=</span><span class="mi">402</span><span class="p">,</span>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a>        <span class="n">content</span><span class="o">=</span><span class="n">payment_request</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a>        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-12-31" name="__codelineno-12-31"></a>            <span class="s2">&quot;X-Payment-Required&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
<a id="__codelineno-12-32" name="__codelineno-12-32"></a>            <span class="s2">&quot;X-Payment-Protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;x402&quot;</span><span class="p">,</span>
<a id="__codelineno-12-33" name="__codelineno-12-33"></a>        <span class="p">}</span>
<a id="__codelineno-12-34" name="__codelineno-12-34"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="3-client-side-implementation">3. Client-Side Implementation<a class="headerlink" href="#3-client-side-implementation" title="Permanent link">&para;</a></h2>
<h3 id="package-openlibx402-client-python-openlibx402client-typescript">Package: <code>openlibx402-client</code> (Python) / <code>@openlibx402/client</code> (TypeScript)<a class="headerlink" href="#package-openlibx402-client-python-openlibx402client-typescript" title="Permanent link">&para;</a></h3>
<h4 id="purpose_2">Purpose<a class="headerlink" href="#purpose_2" title="Permanent link">&para;</a></h4>
<p>Client libraries for making X402-enabled API calls with automatic payment handling.</p>
<h4 id="key-components_2">Key Components<a class="headerlink" href="#key-components_2" title="Permanent link">&para;</a></h4>
<h5 id="31-explicit-client-manual-payment-control">3.1 Explicit Client (Manual Payment Control)<a class="headerlink" href="#31-explicit-client-manual-payment-control" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span>
<span class="normal"><a href="#__codelineno-13-104">104</a></span>
<span class="normal"><a href="#__codelineno-13-105">105</a></span>
<span class="normal"><a href="#__codelineno-13-106">106</a></span>
<span class="normal"><a href="#__codelineno-13-107">107</a></span>
<span class="normal"><a href="#__codelineno-13-108">108</a></span>
<span class="normal"><a href="#__codelineno-13-109">109</a></span>
<span class="normal"><a href="#__codelineno-13-110">110</a></span>
<span class="normal"><a href="#__codelineno-13-111">111</a></span>
<span class="normal"><a href="#__codelineno-13-112">112</a></span>
<span class="normal"><a href="#__codelineno-13-113">113</a></span>
<span class="normal"><a href="#__codelineno-13-114">114</a></span>
<span class="normal"><a href="#__codelineno-13-115">115</a></span>
<span class="normal"><a href="#__codelineno-13-116">116</a></span>
<span class="normal"><a href="#__codelineno-13-117">117</a></span>
<span class="normal"><a href="#__codelineno-13-118">118</a></span>
<span class="normal"><a href="#__codelineno-13-119">119</a></span>
<span class="normal"><a href="#__codelineno-13-120">120</a></span>
<span class="normal"><a href="#__codelineno-13-121">121</a></span>
<span class="normal"><a href="#__codelineno-13-122">122</a></span>
<span class="normal"><a href="#__codelineno-13-123">123</a></span>
<span class="normal"><a href="#__codelineno-13-124">124</a></span>
<span class="normal"><a href="#__codelineno-13-125">125</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402Client</span><span class="p">:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="sd">    Explicit X402 client - developer controls payment flow</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="sd">    Usage:</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="sd">        client = X402Client(wallet_keypair)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="sd">        # Check if payment required</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="sd">        response = await client.get(&quot;https://api.example.com/data&quot;)</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="sd">        if client.payment_required(response):</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="sd">            payment_request = client.parse_payment_request(response)</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="sd">            # Make payment</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="sd">            authorization = await client.create_payment(payment_request)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="sd">            # Retry with payment</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="sd">            response = await client.get(</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="sd">                &quot;https://api.example.com/data&quot;,</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="sd">                payment=authorization</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="sd">            )</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>        <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">,</span>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>        <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>        <span class="n">http_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>    <span class="p">):</span>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span> <span class="o">=</span> <span class="n">wallet_keypair</span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">http_client</span> <span class="o">=</span> <span class="n">http_client</span> <span class="ow">or</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">SolanaPaymentProcessor</span><span class="p">(</span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>            <span class="n">rpc_url</span> <span class="ow">or</span> <span class="s2">&quot;https://api.devnet.solana.com&quot;</span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>        <span class="p">)</span>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>        <span class="n">payment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PaymentAuthorization</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-13-45" name="__codelineno-13-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Make GET request with optional payment&quot;&quot;&quot;</span>
<a id="__codelineno-13-46" name="__codelineno-13-46"></a>        <span class="n">headers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-13-47" name="__codelineno-13-47"></a>        <span class="k">if</span> <span class="n">payment</span><span class="p">:</span>
<a id="__codelineno-13-48" name="__codelineno-13-48"></a>            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Payment-Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">payment</span><span class="o">.</span><span class="n">to_header_value</span><span class="p">()</span>
<a id="__codelineno-13-49" name="__codelineno-13-49"></a>        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headers</span>
<a id="__codelineno-13-50" name="__codelineno-13-50"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-13-51" name="__codelineno-13-51"></a>
<a id="__codelineno-13-52" name="__codelineno-13-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span>
<a id="__codelineno-13-53" name="__codelineno-13-53"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-54" name="__codelineno-13-54"></a>        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-13-55" name="__codelineno-13-55"></a>        <span class="n">payment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PaymentAuthorization</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-13-56" name="__codelineno-13-56"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-13-57" name="__codelineno-13-57"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-13-58" name="__codelineno-13-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Make POST request with optional payment&quot;&quot;&quot;</span>
<a id="__codelineno-13-59" name="__codelineno-13-59"></a>        <span class="k">pass</span>
<a id="__codelineno-13-60" name="__codelineno-13-60"></a>
<a id="__codelineno-13-61" name="__codelineno-13-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">payment_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-13-62" name="__codelineno-13-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if response requires payment&quot;&quot;&quot;</span>
<a id="__codelineno-13-63" name="__codelineno-13-63"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">402</span>
<a id="__codelineno-13-64" name="__codelineno-13-64"></a>
<a id="__codelineno-13-65" name="__codelineno-13-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_payment_request</span><span class="p">(</span>
<a id="__codelineno-13-66" name="__codelineno-13-66"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-67" name="__codelineno-13-67"></a>        <span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span>
<a id="__codelineno-13-68" name="__codelineno-13-68"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PaymentRequest</span><span class="p">:</span>
<a id="__codelineno-13-69" name="__codelineno-13-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse payment request from 402 response&quot;&quot;&quot;</span>
<a id="__codelineno-13-70" name="__codelineno-13-70"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_required</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-13-71" name="__codelineno-13-71"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Response does not require payment&quot;</span><span class="p">)</span>
<a id="__codelineno-13-72" name="__codelineno-13-72"></a>        <span class="k">return</span> <span class="n">PaymentRequest</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
<a id="__codelineno-13-73" name="__codelineno-13-73"></a>
<a id="__codelineno-13-74" name="__codelineno-13-74"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_payment</span><span class="p">(</span>
<a id="__codelineno-13-75" name="__codelineno-13-75"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-13-76" name="__codelineno-13-76"></a>        <span class="n">request</span><span class="p">:</span> <span class="n">PaymentRequest</span><span class="p">,</span>
<a id="__codelineno-13-77" name="__codelineno-13-77"></a>        <span class="n">amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-13-78" name="__codelineno-13-78"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PaymentAuthorization</span><span class="p">:</span>
<a id="__codelineno-13-79" name="__codelineno-13-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-13-80" name="__codelineno-13-80"></a><span class="sd">        Create and broadcast payment for a payment request</span>
<a id="__codelineno-13-81" name="__codelineno-13-81"></a>
<a id="__codelineno-13-82" name="__codelineno-13-82"></a><span class="sd">        Args:</span>
<a id="__codelineno-13-83" name="__codelineno-13-83"></a><span class="sd">            request: Payment request from 402 response</span>
<a id="__codelineno-13-84" name="__codelineno-13-84"></a><span class="sd">            amount: Optional custom amount (defaults to max_amount_required)</span>
<a id="__codelineno-13-85" name="__codelineno-13-85"></a>
<a id="__codelineno-13-86" name="__codelineno-13-86"></a><span class="sd">        Returns:</span>
<a id="__codelineno-13-87" name="__codelineno-13-87"></a><span class="sd">            PaymentAuthorization with transaction hash</span>
<a id="__codelineno-13-88" name="__codelineno-13-88"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-13-89" name="__codelineno-13-89"></a>        <span class="c1"># Validate request not expired</span>
<a id="__codelineno-13-90" name="__codelineno-13-90"></a>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
<a id="__codelineno-13-91" name="__codelineno-13-91"></a>            <span class="k">raise</span> <span class="n">PaymentExpiredError</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-13-92" name="__codelineno-13-92"></a>
<a id="__codelineno-13-93" name="__codelineno-13-93"></a>        <span class="c1"># Use provided amount or max required</span>
<a id="__codelineno-13-94" name="__codelineno-13-94"></a>        <span class="n">pay_amount</span> <span class="o">=</span> <span class="n">amount</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">max_amount_required</span>
<a id="__codelineno-13-95" name="__codelineno-13-95"></a>
<a id="__codelineno-13-96" name="__codelineno-13-96"></a>        <span class="c1"># Check sufficient balance</span>
<a id="__codelineno-13-97" name="__codelineno-13-97"></a>        <span class="n">balance</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">get_token_balance</span><span class="p">(</span>
<a id="__codelineno-13-98" name="__codelineno-13-98"></a>            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span><span class="o">.</span><span class="n">pubkey</span><span class="p">()),</span>
<a id="__codelineno-13-99" name="__codelineno-13-99"></a>            <span class="n">request</span><span class="o">.</span><span class="n">asset_address</span>
<a id="__codelineno-13-100" name="__codelineno-13-100"></a>        <span class="p">)</span>
<a id="__codelineno-13-101" name="__codelineno-13-101"></a>        <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">pay_amount</span><span class="p">):</span>
<a id="__codelineno-13-102" name="__codelineno-13-102"></a>            <span class="k">raise</span> <span class="n">InsufficientFundsError</span><span class="p">(</span><span class="n">pay_amount</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">balance</span><span class="p">))</span>
<a id="__codelineno-13-103" name="__codelineno-13-103"></a>
<a id="__codelineno-13-104" name="__codelineno-13-104"></a>        <span class="c1"># Create transaction</span>
<a id="__codelineno-13-105" name="__codelineno-13-105"></a>        <span class="n">tx</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">create_payment_transaction</span><span class="p">(</span>
<a id="__codelineno-13-106" name="__codelineno-13-106"></a>            <span class="n">request</span><span class="p">,</span> <span class="n">pay_amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span>
<a id="__codelineno-13-107" name="__codelineno-13-107"></a>        <span class="p">)</span>
<a id="__codelineno-13-108" name="__codelineno-13-108"></a>
<a id="__codelineno-13-109" name="__codelineno-13-109"></a>        <span class="c1"># Sign and broadcast</span>
<a id="__codelineno-13-110" name="__codelineno-13-110"></a>        <span class="n">tx_hash</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">sign_and_send_transaction</span><span class="p">(</span>
<a id="__codelineno-13-111" name="__codelineno-13-111"></a>            <span class="n">tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span>
<a id="__codelineno-13-112" name="__codelineno-13-112"></a>        <span class="p">)</span>
<a id="__codelineno-13-113" name="__codelineno-13-113"></a>
<a id="__codelineno-13-114" name="__codelineno-13-114"></a>        <span class="c1"># Create authorization</span>
<a id="__codelineno-13-115" name="__codelineno-13-115"></a>        <span class="k">return</span> <span class="n">PaymentAuthorization</span><span class="p">(</span>
<a id="__codelineno-13-116" name="__codelineno-13-116"></a>            <span class="n">payment_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
<a id="__codelineno-13-117" name="__codelineno-13-117"></a>            <span class="n">actual_amount</span><span class="o">=</span><span class="n">pay_amount</span><span class="p">,</span>
<a id="__codelineno-13-118" name="__codelineno-13-118"></a>            <span class="n">payment_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">payment_address</span><span class="p">,</span>
<a id="__codelineno-13-119" name="__codelineno-13-119"></a>            <span class="n">asset_address</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">asset_address</span><span class="p">,</span>
<a id="__codelineno-13-120" name="__codelineno-13-120"></a>            <span class="n">network</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
<a id="__codelineno-13-121" name="__codelineno-13-121"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
<a id="__codelineno-13-122" name="__codelineno-13-122"></a>            <span class="n">signature</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Solana signature</span>
<a id="__codelineno-13-123" name="__codelineno-13-123"></a>            <span class="n">public_key</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span><span class="o">.</span><span class="n">pubkey</span><span class="p">()),</span>
<a id="__codelineno-13-124" name="__codelineno-13-124"></a>            <span class="n">transaction_hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">,</span>
<a id="__codelineno-13-125" name="__codelineno-13-125"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h5 id="32-implicit-client-automatic-payment">3.2 Implicit Client (Automatic Payment)<a class="headerlink" href="#32-implicit-client-automatic-payment" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">  1</a></span>
<span class="normal"><a href="#__codelineno-14-2">  2</a></span>
<span class="normal"><a href="#__codelineno-14-3">  3</a></span>
<span class="normal"><a href="#__codelineno-14-4">  4</a></span>
<span class="normal"><a href="#__codelineno-14-5">  5</a></span>
<span class="normal"><a href="#__codelineno-14-6">  6</a></span>
<span class="normal"><a href="#__codelineno-14-7">  7</a></span>
<span class="normal"><a href="#__codelineno-14-8">  8</a></span>
<span class="normal"><a href="#__codelineno-14-9">  9</a></span>
<span class="normal"><a href="#__codelineno-14-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-14-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-14-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-14-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-14-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-14-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-14-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-14-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-14-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-14-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-14-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-14-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-14-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-14-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-14-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-14-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-14-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-14-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-14-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-14-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-14-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-14-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-14-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-14-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-14-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-14-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-14-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-14-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-14-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-14-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-14-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-14-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-14-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-14-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-14-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-14-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-14-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-14-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-14-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-14-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-14-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-14-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-14-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-14-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-14-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-14-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-14-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-14-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-14-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-14-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-14-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-14-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-14-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-14-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-14-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-14-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-14-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-14-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-14-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-14-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-14-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-14-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-14-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-14-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-14-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-14-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-14-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-14-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-14-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-14-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-14-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-14-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-14-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-14-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-14-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-14-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-14-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-14-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-14-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-14-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-14-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-14-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-14-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-14-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-14-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-14-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-14-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-14-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-14-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-14-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-14-100">100</a></span>
<span class="normal"><a href="#__codelineno-14-101">101</a></span>
<span class="normal"><a href="#__codelineno-14-102">102</a></span>
<span class="normal"><a href="#__codelineno-14-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402AutoClient</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="sd">    Implicit X402 client - automatically handles payment flow</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="sd">    Usage:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="sd">        client = X402AutoClient(wallet_keypair)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="sd">        # Automatically detects 402 and pays</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="sd">        response = await client.fetch(&quot;https://api.example.com/data&quot;)</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="sd">        data = response.json()</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a>        <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">,</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a>        <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a>        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a>        <span class="n">auto_retry</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a>        <span class="n">max_payment_amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Safety limit</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a>    <span class="p">):</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">X402Client</span><span class="p">(</span><span class="n">wallet_keypair</span><span class="p">,</span> <span class="n">rpc_url</span><span class="p">)</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">auto_retry</span> <span class="o">=</span> <span class="n">auto_retry</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_payment_amount</span> <span class="o">=</span> <span class="n">max_payment_amount</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a>        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a>        <span class="n">auto_retry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="sd">        Make HTTP request with automatic payment handling</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="sd">        Args:</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="sd">            url: Request URL</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="sd">            method: HTTP method</span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="sd">            auto_retry: Override instance auto_retry setting</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="sd">            **kwargs: Additional arguments for httpx request</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="sd">        Returns:</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="sd">            Response after payment (if required)</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="sd">        Raises:</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="sd">            PaymentRequiredError: If auto_retry is False and 402 received</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a><span class="sd">            InsufficientFundsError: If wallet lacks funds</span>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a><span class="sd">            PaymentExpiredError: If payment request expired</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a>        <span class="n">should_retry</span> <span class="o">=</span> <span class="n">auto_retry</span> <span class="k">if</span> <span class="n">auto_retry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_retry</span>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a>        <span class="c1"># Initial request</span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a>        <span class="c1"># Check if payment required</span>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">payment_required</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">should_retry</span><span class="p">:</span>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a>                <span class="k">raise</span> <span class="n">PaymentRequiredError</span><span class="p">(</span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">parse_payment_request</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-14-60" name="__codelineno-14-60"></a>                <span class="p">)</span>
<a id="__codelineno-14-61" name="__codelineno-14-61"></a>
<a id="__codelineno-14-62" name="__codelineno-14-62"></a>            <span class="c1"># Parse payment request</span>
<a id="__codelineno-14-63" name="__codelineno-14-63"></a>            <span class="n">payment_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">parse_payment_request</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-14-64" name="__codelineno-14-64"></a>
<a id="__codelineno-14-65" name="__codelineno-14-65"></a>            <span class="c1"># Safety check</span>
<a id="__codelineno-14-66" name="__codelineno-14-66"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_payment_amount</span><span class="p">:</span>
<a id="__codelineno-14-67" name="__codelineno-14-67"></a>                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">payment_request</span><span class="o">.</span><span class="n">max_amount_required</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_payment_amount</span><span class="p">):</span>
<a id="__codelineno-14-68" name="__codelineno-14-68"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-14-69" name="__codelineno-14-69"></a>                        <span class="sa">f</span><span class="s2">&quot;Payment amount </span><span class="si">{</span><span class="n">payment_request</span><span class="o">.</span><span class="n">max_amount_required</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-14-70" name="__codelineno-14-70"></a>                        <span class="sa">f</span><span class="s2">&quot;exceeds max allowed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_payment_amount</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-14-71" name="__codelineno-14-71"></a>                    <span class="p">)</span>
<a id="__codelineno-14-72" name="__codelineno-14-72"></a>
<a id="__codelineno-14-73" name="__codelineno-14-73"></a>            <span class="c1"># Create payment</span>
<a id="__codelineno-14-74" name="__codelineno-14-74"></a>            <span class="n">authorization</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span><span class="n">payment_request</span><span class="p">)</span>
<a id="__codelineno-14-75" name="__codelineno-14-75"></a>
<a id="__codelineno-14-76" name="__codelineno-14-76"></a>            <span class="c1"># Retry with payment</span>
<a id="__codelineno-14-77" name="__codelineno-14-77"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
<a id="__codelineno-14-78" name="__codelineno-14-78"></a>                <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">payment</span><span class="o">=</span><span class="n">authorization</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-14-79" name="__codelineno-14-79"></a>            <span class="p">)</span>
<a id="__codelineno-14-80" name="__codelineno-14-80"></a>
<a id="__codelineno-14-81" name="__codelineno-14-81"></a>        <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-14-82" name="__codelineno-14-82"></a>
<a id="__codelineno-14-83" name="__codelineno-14-83"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_make_request</span><span class="p">(</span>
<a id="__codelineno-14-84" name="__codelineno-14-84"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-14-85" name="__codelineno-14-85"></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-14-86" name="__codelineno-14-86"></a>        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-14-87" name="__codelineno-14-87"></a>        <span class="n">payment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PaymentAuthorization</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-88" name="__codelineno-14-88"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-14-89" name="__codelineno-14-89"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-14-90" name="__codelineno-14-90"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method to make HTTP request&quot;&quot;&quot;</span>
<a id="__codelineno-14-91" name="__codelineno-14-91"></a>        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
<a id="__codelineno-14-92" name="__codelineno-14-92"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">payment</span><span class="o">=</span><span class="n">payment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-14-93" name="__codelineno-14-93"></a>        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
<a id="__codelineno-14-94" name="__codelineno-14-94"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">payment</span><span class="o">=</span><span class="n">payment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-14-95" name="__codelineno-14-95"></a>        <span class="c1"># ... other methods</span>
<a id="__codelineno-14-96" name="__codelineno-14-96"></a>
<a id="__codelineno-14-97" name="__codelineno-14-97"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-14-98" name="__codelineno-14-98"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;GET request with auto-payment&quot;&quot;&quot;</span>
<a id="__codelineno-14-99" name="__codelineno-14-99"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-14-100" name="__codelineno-14-100"></a>
<a id="__codelineno-14-101" name="__codelineno-14-101"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<a id="__codelineno-14-102" name="__codelineno-14-102"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;POST request with auto-payment&quot;&quot;&quot;</span>
<a id="__codelineno-14-103" name="__codelineno-14-103"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span>
<span class="normal"><a href="#__codelineno-15-7">7</a></span>
<span class="normal"><a href="#__codelineno-15-8">8</a></span>
<span class="normal"><a href="#__codelineno-15-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1">// TypeScript versions with similar structure</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">X402Client</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">  </span><span class="c1">// Explicit client implementation</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="p">}</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">X402AutoClient</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">  </span><span class="c1">// Implicit auto-payment client implementation</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="4-langchain-integration">4. LangChain Integration<a class="headerlink" href="#4-langchain-integration" title="Permanent link">&para;</a></h2>
<h3 id="package-openlibx402-langchain-python-openlibx402langchain-typescript">Package: <code>openlibx402-langchain</code> (Python) / <code>@openlibx402/langchain</code> (TypeScript)<a class="headerlink" href="#package-openlibx402-langchain-python-openlibx402langchain-typescript" title="Permanent link">&para;</a></h3>
<h4 id="purpose_3">Purpose<a class="headerlink" href="#purpose_3" title="Permanent link">&para;</a></h4>
<p>Integrate X402 payments into LangChain agents via Tools and HTTP request middleware.</p>
<h4 id="key-components_3">Key Components<a class="headerlink" href="#key-components_3" title="Permanent link">&para;</a></h4>
<h5 id="41-x402-tool-for-agents">4.1 X402 Tool (For Agents)<a class="headerlink" href="#41-x402-tool-for-agents" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span>
<span class="normal"><a href="#__codelineno-16-45">45</a></span>
<span class="normal"><a href="#__codelineno-16-46">46</a></span>
<span class="normal"><a href="#__codelineno-16-47">47</a></span>
<span class="normal"><a href="#__codelineno-16-48">48</a></span>
<span class="normal"><a href="#__codelineno-16-49">49</a></span>
<span class="normal"><a href="#__codelineno-16-50">50</a></span>
<span class="normal"><a href="#__codelineno-16-51">51</a></span>
<span class="normal"><a href="#__codelineno-16-52">52</a></span>
<span class="normal"><a href="#__codelineno-16-53">53</a></span>
<span class="normal"><a href="#__codelineno-16-54">54</a></span>
<span class="normal"><a href="#__codelineno-16-55">55</a></span>
<span class="normal"><a href="#__codelineno-16-56">56</a></span>
<span class="normal"><a href="#__codelineno-16-57">57</a></span>
<span class="normal"><a href="#__codelineno-16-58">58</a></span>
<span class="normal"><a href="#__codelineno-16-59">59</a></span>
<span class="normal"><a href="#__codelineno-16-60">60</a></span>
<span class="normal"><a href="#__codelineno-16-61">61</a></span>
<span class="normal"><a href="#__codelineno-16-62">62</a></span>
<span class="normal"><a href="#__codelineno-16-63">63</a></span>
<span class="normal"><a href="#__codelineno-16-64">64</a></span>
<span class="normal"><a href="#__codelineno-16-65">65</a></span>
<span class="normal"><a href="#__codelineno-16-66">66</a></span>
<span class="normal"><a href="#__codelineno-16-67">67</a></span>
<span class="normal"><a href="#__codelineno-16-68">68</a></span>
<span class="normal"><a href="#__codelineno-16-69">69</a></span>
<span class="normal"><a href="#__codelineno-16-70">70</a></span>
<span class="normal"><a href="#__codelineno-16-71">71</a></span>
<span class="normal"><a href="#__codelineno-16-72">72</a></span>
<span class="normal"><a href="#__codelineno-16-73">73</a></span>
<span class="normal"><a href="#__codelineno-16-74">74</a></span>
<span class="normal"><a href="#__codelineno-16-75">75</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTool</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402PaymentTool</span><span class="p">(</span><span class="n">BaseTool</span><span class="p">):</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="sd">    LangChain tool that allows agents to make payments for API access</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="sd">    Usage:</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="sd">        wallet_keypair = load_keypair()</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="sd">        payment_tool = X402PaymentTool(</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="sd">            wallet_keypair=wallet_keypair,</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="sd">            name=&quot;pay_for_api&quot;,</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="sd">            description=&quot;Make payment to access premium API data&quot;</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="sd">        )</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="sd">        agent = initialize_agent(</span>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="sd">            tools=[payment_tool, ...],</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="sd">            llm=llm,</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="sd">        )</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;x402_payment&quot;</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a>        <span class="s2">&quot;Make an X402 payment to access a paid API endpoint. &quot;</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a>        <span class="s2">&quot;Input should be a JSON string with &#39;url&#39; and optional &#39;amount&#39;. &quot;</span>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a>        <span class="s2">&quot;Returns the API response after successful payment.&quot;</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a>    <span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a>    <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a>    <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a>    <span class="n">max_payment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a>        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a>        <span class="n">amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<a id="__codelineno-16-40" name="__codelineno-16-40"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-16-41" name="__codelineno-16-41"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronous run (calls async version)&quot;&quot;&quot;</span>
<a id="__codelineno-16-43" name="__codelineno-16-43"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-16-44" name="__codelineno-16-44"></a>        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arun</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<a id="__codelineno-16-45" name="__codelineno-16-45"></a>
<a id="__codelineno-16-46" name="__codelineno-16-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_arun</span><span class="p">(</span>
<a id="__codelineno-16-47" name="__codelineno-16-47"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-48" name="__codelineno-16-48"></a>        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-16-49" name="__codelineno-16-49"></a>        <span class="n">amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-16-50" name="__codelineno-16-50"></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<a id="__codelineno-16-51" name="__codelineno-16-51"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-16-52" name="__codelineno-16-52"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-16-53" name="__codelineno-16-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-54" name="__codelineno-16-54"></a><span class="sd">        Make paid API request</span>
<a id="__codelineno-16-55" name="__codelineno-16-55"></a>
<a id="__codelineno-16-56" name="__codelineno-16-56"></a><span class="sd">        Args:</span>
<a id="__codelineno-16-57" name="__codelineno-16-57"></a><span class="sd">            url: API endpoint URL</span>
<a id="__codelineno-16-58" name="__codelineno-16-58"></a><span class="sd">            amount: Optional payment amount override</span>
<a id="__codelineno-16-59" name="__codelineno-16-59"></a><span class="sd">            method: HTTP method</span>
<a id="__codelineno-16-60" name="__codelineno-16-60"></a><span class="sd">            **kwargs: Additional request parameters</span>
<a id="__codelineno-16-61" name="__codelineno-16-61"></a>
<a id="__codelineno-16-62" name="__codelineno-16-62"></a><span class="sd">        Returns:</span>
<a id="__codelineno-16-63" name="__codelineno-16-63"></a><span class="sd">            API response as string</span>
<a id="__codelineno-16-64" name="__codelineno-16-64"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-16-65" name="__codelineno-16-65"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span>
<a id="__codelineno-16-66" name="__codelineno-16-66"></a>            <span class="n">wallet_keypair</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span><span class="p">,</span>
<a id="__codelineno-16-67" name="__codelineno-16-67"></a>            <span class="n">rpc_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rpc_url</span><span class="p">,</span>
<a id="__codelineno-16-68" name="__codelineno-16-68"></a>            <span class="n">max_payment_amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_payment</span><span class="p">,</span>
<a id="__codelineno-16-69" name="__codelineno-16-69"></a>        <span class="p">)</span>
<a id="__codelineno-16-70" name="__codelineno-16-70"></a>
<a id="__codelineno-16-71" name="__codelineno-16-71"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-72" name="__codelineno-16-72"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-16-73" name="__codelineno-16-73"></a>            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-16-74" name="__codelineno-16-74"></a>        <span class="k">except</span> <span class="n">X402Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-75" name="__codelineno-16-75"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Payment error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
<h5 id="42-request-middleware-intercept-all-api-calls">4.2 Request Middleware (Intercept All API Calls)<a class="headerlink" href="#42-request-middleware-intercept-all-api-calls" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span>
<span class="normal"><a href="#__codelineno-17-31">31</a></span>
<span class="normal"><a href="#__codelineno-17-32">32</a></span>
<span class="normal"><a href="#__codelineno-17-33">33</a></span>
<span class="normal"><a href="#__codelineno-17-34">34</a></span>
<span class="normal"><a href="#__codelineno-17-35">35</a></span>
<span class="normal"><a href="#__codelineno-17-36">36</a></span>
<span class="normal"><a href="#__codelineno-17-37">37</a></span>
<span class="normal"><a href="#__codelineno-17-38">38</a></span>
<span class="normal"><a href="#__codelineno-17-39">39</a></span>
<span class="normal"><a href="#__codelineno-17-40">40</a></span>
<span class="normal"><a href="#__codelineno-17-41">41</a></span>
<span class="normal"><a href="#__codelineno-17-42">42</a></span>
<span class="normal"><a href="#__codelineno-17-43">43</a></span>
<span class="normal"><a href="#__codelineno-17-44">44</a></span>
<span class="normal"><a href="#__codelineno-17-45">45</a></span>
<span class="normal"><a href="#__codelineno-17-46">46</a></span>
<span class="normal"><a href="#__codelineno-17-47">47</a></span>
<span class="normal"><a href="#__codelineno-17-48">48</a></span>
<span class="normal"><a href="#__codelineno-17-49">49</a></span>
<span class="normal"><a href="#__codelineno-17-50">50</a></span>
<span class="normal"><a href="#__codelineno-17-51">51</a></span>
<span class="normal"><a href="#__codelineno-17-52">52</a></span>
<span class="normal"><a href="#__codelineno-17-53">53</a></span>
<span class="normal"><a href="#__codelineno-17-54">54</a></span>
<span class="normal"><a href="#__codelineno-17-55">55</a></span>
<span class="normal"><a href="#__codelineno-17-56">56</a></span>
<span class="normal"><a href="#__codelineno-17-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestsWrapper</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402RequestsWrapper</span><span class="p">(</span><span class="n">RequestsWrapper</span><span class="p">):</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="sd">    Drop-in replacement for LangChain&#39;s RequestsWrapper with X402 support</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="sd">    Usage:</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="sd">        from langchain.agents import load_tools</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="sd">        wallet_keypair = load_keypair()</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="sd">        requests_wrapper = X402RequestsWrapper(</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="sd">            wallet_keypair=wallet_keypair</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="sd">        )</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="sd">        # Use with LangChain tools that make HTTP requests</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="sd">        tools = load_tools(</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="sd">            [&quot;requests_all&quot;],</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="sd">            llm=llm,</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="sd">            requests_wrapper=requests_wrapper</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="sd">        )</span>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a>        <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">,</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>        <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>        <span class="n">max_payment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a>    <span class="p">):</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a>            <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">wallet_keypair</span><span class="p">,</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a>            <span class="n">rpc_url</span><span class="o">=</span><span class="n">rpc_url</span><span class="p">,</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a>            <span class="n">max_payment_amount</span><span class="o">=</span><span class="n">max_payment</span><span class="p">,</span>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>        <span class="p">)</span>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async GET with X402 support&quot;&quot;&quot;</span>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-17-42" name="__codelineno-17-42"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-17-43" name="__codelineno-17-43"></a>
<a id="__codelineno-17-44" name="__codelineno-17-44"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async POST with X402 support&quot;&quot;&quot;</span>
<a id="__codelineno-17-46" name="__codelineno-17-46"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-17-47" name="__codelineno-17-47"></a>        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-17-48" name="__codelineno-17-48"></a>
<a id="__codelineno-17-49" name="__codelineno-17-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-17-50" name="__codelineno-17-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sync GET with X402 support&quot;&quot;&quot;</span>
<a id="__codelineno-17-51" name="__codelineno-17-51"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-17-52" name="__codelineno-17-52"></a>        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<a id="__codelineno-17-53" name="__codelineno-17-53"></a>
<a id="__codelineno-17-54" name="__codelineno-17-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-17-55" name="__codelineno-17-55"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sync POST with X402 support&quot;&quot;&quot;</span>
<a id="__codelineno-17-56" name="__codelineno-17-56"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-17-57" name="__codelineno-17-57"></a>        <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apost</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<h5 id="43-integration-utilities">4.3 Integration Utilities<a class="headerlink" href="#43-integration-utilities" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span>
<span class="normal"><a href="#__codelineno-18-49">49</a></span>
<span class="normal"><a href="#__codelineno-18-50">50</a></span>
<span class="normal"><a href="#__codelineno-18-51">51</a></span>
<span class="normal"><a href="#__codelineno-18-52">52</a></span>
<span class="normal"><a href="#__codelineno-18-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_agent</span><span class="p">,</span> <span class="n">AgentType</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_x402_agent</span><span class="p">(</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>    <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">,</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>    <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>    <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a>    <span class="n">max_payment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>    <span class="o">**</span><span class="n">agent_kwargs</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="p">):</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="sd">    Convenience function to create LangChain agent with X402 support</span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="sd">    Usage:</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="sd">        agent = create_x402_agent(</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="sd">            wallet_keypair=my_keypair,</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="sd">            llm=ChatOpenAI(),</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="sd">            tools=[custom_tool_1, custom_tool_2],</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="sd">            max_payment=&quot;5.0&quot;</span>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="sd">        )</span>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="sd">        response = agent.run(&quot;Get me premium market data from api.example.com&quot;)</span>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a>    <span class="c1"># Create X402-enabled requests wrapper</span>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a>    <span class="n">requests_wrapper</span> <span class="o">=</span> <span class="n">X402RequestsWrapper</span><span class="p">(</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a>        <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">wallet_keypair</span><span class="p">,</span>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a>        <span class="n">rpc_url</span><span class="o">=</span><span class="n">rpc_url</span><span class="p">,</span>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a>        <span class="n">max_payment</span><span class="o">=</span><span class="n">max_payment</span><span class="p">,</span>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a>    <span class="p">)</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a>    <span class="c1"># Load standard tools with X402 wrapper</span>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a>    <span class="n">x402_tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">(</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a>        <span class="p">[</span><span class="s2">&quot;requests_all&quot;</span><span class="p">],</span>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a>        <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
<a id="__codelineno-18-38" name="__codelineno-18-38"></a>        <span class="n">requests_wrapper</span><span class="o">=</span><span class="n">requests_wrapper</span>
<a id="__codelineno-18-39" name="__codelineno-18-39"></a>    <span class="p">)</span>
<a id="__codelineno-18-40" name="__codelineno-18-40"></a>
<a id="__codelineno-18-41" name="__codelineno-18-41"></a>    <span class="c1"># Add custom tools</span>
<a id="__codelineno-18-42" name="__codelineno-18-42"></a>    <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
<a id="__codelineno-18-43" name="__codelineno-18-43"></a>        <span class="n">x402_tools</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
<a id="__codelineno-18-44" name="__codelineno-18-44"></a>
<a id="__codelineno-18-45" name="__codelineno-18-45"></a>    <span class="c1"># Create agent</span>
<a id="__codelineno-18-46" name="__codelineno-18-46"></a>    <span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span>
<a id="__codelineno-18-47" name="__codelineno-18-47"></a>        <span class="n">tools</span><span class="o">=</span><span class="n">x402_tools</span><span class="p">,</span>
<a id="__codelineno-18-48" name="__codelineno-18-48"></a>        <span class="n">llm</span><span class="o">=</span><span class="n">llm</span> <span class="ow">or</span> <span class="n">ChatOpenAI</span><span class="p">(),</span>
<a id="__codelineno-18-49" name="__codelineno-18-49"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span>
<a id="__codelineno-18-50" name="__codelineno-18-50"></a>        <span class="o">**</span><span class="n">agent_kwargs</span>
<a id="__codelineno-18-51" name="__codelineno-18-51"></a>    <span class="p">)</span>
<a id="__codelineno-18-52" name="__codelineno-18-52"></a>
<a id="__codelineno-18-53" name="__codelineno-18-53"></a>    <span class="k">return</span> <span class="n">agent</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="5-langgraph-integration">5. LangGraph Integration<a class="headerlink" href="#5-langgraph-integration" title="Permanent link">&para;</a></h2>
<h3 id="package-openlibx402-langgraph-python-openlibx402langgraph-typescript">Package: <code>openlibx402-langgraph</code> (Python) / <code>@openlibx402/langgraph</code> (TypeScript)<a class="headerlink" href="#package-openlibx402-langgraph-python-openlibx402langgraph-typescript" title="Permanent link">&para;</a></h3>
<h4 id="purpose_4">Purpose<a class="headerlink" href="#purpose_4" title="Permanent link">&para;</a></h4>
<p>Integrate X402 payments into LangGraph workflows as nodes and conditional edges.</p>
<h4 id="recommended-patterns">Recommended Patterns<a class="headerlink" href="#recommended-patterns" title="Permanent link">&para;</a></h4>
<h5 id="51-payment-node">5.1 Payment Node<a class="headerlink" href="#51-payment-node" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span>
<span class="normal"><a href="#__codelineno-19-34">34</a></span>
<span class="normal"><a href="#__codelineno-19-35">35</a></span>
<span class="normal"><a href="#__codelineno-19-36">36</a></span>
<span class="normal"><a href="#__codelineno-19-37">37</a></span>
<span class="normal"><a href="#__codelineno-19-38">38</a></span>
<span class="normal"><a href="#__codelineno-19-39">39</a></span>
<span class="normal"><a href="#__codelineno-19-40">40</a></span>
<span class="normal"><a href="#__codelineno-19-41">41</a></span>
<span class="normal"><a href="#__codelineno-19-42">42</a></span>
<span class="normal"><a href="#__codelineno-19-43">43</a></span>
<span class="normal"><a href="#__codelineno-19-44">44</a></span>
<span class="normal"><a href="#__codelineno-19-45">45</a></span>
<span class="normal"><a href="#__codelineno-19-46">46</a></span>
<span class="normal"><a href="#__codelineno-19-47">47</a></span>
<span class="normal"><a href="#__codelineno-19-48">48</a></span>
<span class="normal"><a href="#__codelineno-19-49">49</a></span>
<span class="normal"><a href="#__codelineno-19-50">50</a></span>
<span class="normal"><a href="#__codelineno-19-51">51</a></span>
<span class="normal"><a href="#__codelineno-19-52">52</a></span>
<span class="normal"><a href="#__codelineno-19-53">53</a></span>
<span class="normal"><a href="#__codelineno-19-54">54</a></span>
<span class="normal"><a href="#__codelineno-19-55">55</a></span>
<span class="normal"><a href="#__codelineno-19-56">56</a></span>
<span class="normal"><a href="#__codelineno-19-57">57</a></span>
<span class="normal"><a href="#__codelineno-19-58">58</a></span>
<span class="normal"><a href="#__codelineno-19-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Annotated</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solders.keypair</span><span class="w"> </span><span class="kn">import</span> <span class="n">Keypair</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;State for LangGraph agent with payment support&quot;&quot;&quot;</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a>    <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>    <span class="n">api_url</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a>    <span class="n">api_response</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a>    <span class="n">payment_required</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>    <span class="n">payment_completed</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>    <span class="n">payment_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a>    <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">payment_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="sd">    LangGraph node that handles X402 payment</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="sd">    Usage in graph:</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="sd">        workflow = StateGraph(AgentState)</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="sd">        workflow.add_node(&quot;fetch_api&quot;, fetch_api_node)</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="sd">        workflow.add_node(&quot;make_payment&quot;, payment_node)</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="sd">        workflow.add_node(&quot;process_response&quot;, process_response_node)</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="sd">        workflow.add_conditional_edges(</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="sd">            &quot;fetch_api&quot;,</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="sd">            check_payment_required,</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="sd">            {</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="sd">                &quot;payment_required&quot;: &quot;make_payment&quot;,</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a><span class="sd">                &quot;success&quot;: &quot;process_response&quot;</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="sd">            }</span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="sd">        )</span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-19-34" name="__codelineno-19-34"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span>
<a id="__codelineno-19-35" name="__codelineno-19-35"></a>        <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;wallet_keypair&quot;</span><span class="p">],</span>
<a id="__codelineno-19-36" name="__codelineno-19-36"></a>        <span class="n">auto_retry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-19-37" name="__codelineno-19-37"></a>    <span class="p">)</span>
<a id="__codelineno-19-38" name="__codelineno-19-38"></a>
<a id="__codelineno-19-39" name="__codelineno-19-39"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-19-40" name="__codelineno-19-40"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-19-41" name="__codelineno-19-41"></a>            <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">])</span>
<a id="__codelineno-19-42" name="__codelineno-19-42"></a>        <span class="p">)</span>
<a id="__codelineno-19-43" name="__codelineno-19-43"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-19-44" name="__codelineno-19-44"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-19-45" name="__codelineno-19-45"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-19-46" name="__codelineno-19-46"></a>    <span class="k">except</span> <span class="n">X402Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-19-47" name="__codelineno-19-47"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-19-48" name="__codelineno-19-48"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-19-49" name="__codelineno-19-49"></a>
<a id="__codelineno-19-50" name="__codelineno-19-50"></a>    <span class="k">return</span> <span class="n">state</span>
<a id="__codelineno-19-51" name="__codelineno-19-51"></a>
<a id="__codelineno-19-52" name="__codelineno-19-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_payment_required</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-19-53" name="__codelineno-19-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Conditional edge function&quot;&quot;&quot;</span>
<a id="__codelineno-19-54" name="__codelineno-19-54"></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payment_required&quot;</span><span class="p">):</span>
<a id="__codelineno-19-55" name="__codelineno-19-55"></a>        <span class="k">return</span> <span class="s2">&quot;payment_required&quot;</span>
<a id="__codelineno-19-56" name="__codelineno-19-56"></a>    <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_response&quot;</span><span class="p">):</span>
<a id="__codelineno-19-57" name="__codelineno-19-57"></a>        <span class="k">return</span> <span class="s2">&quot;success&quot;</span>
<a id="__codelineno-19-58" name="__codelineno-19-58"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-19-59" name="__codelineno-19-59"></a>        <span class="k">return</span> <span class="s2">&quot;error&quot;</span>
</code></pre></div></td></tr></table></div>
<h5 id="52-payment-aware-api-node">5.2 Payment-Aware API Node<a class="headerlink" href="#52-payment-aware-api-node" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_with_payment_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="sd">    Combined node that fetches API and handles payment automatically</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="sd">    This is simpler than separate nodes but gives less control</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>        <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;wallet_keypair&quot;</span><span class="p">],</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a>        <span class="n">max_payment_amount</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a>    <span class="p">)</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a>            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">],</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a>            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>        <span class="p">)</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a>    <span class="k">except</span> <span class="n">InsufficientFundsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Insufficient funds: need </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">required_amount</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a>    <span class="k">except</span> <span class="n">X402Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-20-23" name="__codelineno-20-23"></a>
<a id="__codelineno-20-24" name="__codelineno-20-24"></a>    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
<h5 id="53-example-workflow">5.3 Example Workflow<a class="headerlink" href="#53-example-workflow" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_x402_workflow</span><span class="p">(</span><span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="sd">    Create a LangGraph workflow with X402 payment support</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="sd">    Workflow:</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="sd">        1. Determine what API to call</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="sd">        2. Check if payment required</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="sd">        3. Make payment if needed</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="sd">        4. Process response</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a>    <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AgentState</span><span class="p">)</span>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a>    <span class="c1"># Add nodes</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="n">planning_node</span><span class="p">)</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;fetch_api&quot;</span><span class="p">,</span> <span class="n">fetch_api_node</span><span class="p">)</span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;make_payment&quot;</span><span class="p">,</span> <span class="n">payment_node</span><span class="p">)</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">process_response_node</span><span class="p">)</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a>    <span class="c1"># Set entry point</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>    <span class="c1"># Add edges</span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="s2">&quot;fetch_api&quot;</span><span class="p">)</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a>        <span class="s2">&quot;fetch_api&quot;</span><span class="p">,</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>        <span class="n">check_payment_required</span><span class="p">,</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a>        <span class="p">{</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a>            <span class="s2">&quot;payment_required&quot;</span><span class="p">:</span> <span class="s2">&quot;make_payment&quot;</span><span class="p">,</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">END</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>        <span class="p">}</span>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a>    <span class="p">)</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;make_payment&quot;</span><span class="p">,</span> <span class="s2">&quot;fetch_api&quot;</span><span class="p">)</span>  <span class="c1"># Retry after payment</span>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a>
<a id="__codelineno-21-41" name="__codelineno-21-41"></a>    <span class="k">return</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h5 id="54-helper-functions">5.4 Helper Functions<a class="headerlink" href="#54-helper-functions" title="Permanent link">&para;</a></h5>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_payment_capable_graph</span><span class="p">(</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>    <span class="n">state_schema</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>    <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">,</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>    <span class="n">rpc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="sd">    Create a StateGraph with X402 payment capabilities built-in</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="sd">    Automatically adds wallet_keypair to state and provides helper methods</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>    <span class="k">pass</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">add_payment_node</span><span class="p">(</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>    <span class="n">graph</span><span class="p">:</span> <span class="n">StateGraph</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a>    <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;x402_payment&quot;</span><span class="p">,</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a>    <span class="n">max_payment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateGraph</span><span class="p">:</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a payment node to existing graph&quot;&quot;&quot;</span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="6-error-handling-retry-logic">6. Error Handling &amp; Retry Logic<a class="headerlink" href="#6-error-handling-retry-logic" title="Permanent link">&para;</a></h2>
<h3 id="automatic-retry-configuration">Automatic Retry Configuration<a class="headerlink" href="#automatic-retry-configuration" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="nd">@dataclass</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">RetryConfig</span><span class="p">:</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for automatic retry behavior&quot;&quot;&quot;</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a>    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># For payment, 1 retry is usually sufficient</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>    <span class="n">retry_on_402</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Retry when 402 received</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a>    <span class="n">retry_on_network_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>    <span class="n">exponential_backoff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Usually not needed for 402</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">X402ClientWithRetry</span><span class="p">:</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Client with configurable retry logic&quot;&quot;&quot;</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>        <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span><span class="p">,</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>        <span class="n">retry_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RetryConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>    <span class="p">):</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wallet_keypair</span> <span class="o">=</span> <span class="n">wallet_keypair</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry_config</span> <span class="o">=</span> <span class="n">retry_config</span> <span class="ow">or</span> <span class="n">RetryConfig</span><span class="p">()</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a>            <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">wallet_keypair</span><span class="p">,</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>            <span class="n">auto_retry</span><span class="o">=</span><span class="n">retry_config</span><span class="o">.</span><span class="n">enabled</span> <span class="k">if</span> <span class="n">retry_config</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="error-code-reference">Error Code Reference<a class="headerlink" href="#error-code-reference" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span>
<span class="normal"><a href="#__codelineno-24-22">22</a></span>
<span class="normal"><a href="#__codelineno-24-23">23</a></span>
<span class="normal"><a href="#__codelineno-24-24">24</a></span>
<span class="normal"><a href="#__codelineno-24-25">25</a></span>
<span class="normal"><a href="#__codelineno-24-26">26</a></span>
<span class="normal"><a href="#__codelineno-24-27">27</a></span>
<span class="normal"><a href="#__codelineno-24-28">28</a></span>
<span class="normal"><a href="#__codelineno-24-29">29</a></span>
<span class="normal"><a href="#__codelineno-24-30">30</a></span>
<span class="normal"><a href="#__codelineno-24-31">31</a></span>
<span class="normal"><a href="#__codelineno-24-32">32</a></span>
<span class="normal"><a href="#__codelineno-24-33">33</a></span>
<span class="normal"><a href="#__codelineno-24-34">34</a></span>
<span class="normal"><a href="#__codelineno-24-35">35</a></span>
<span class="normal"><a href="#__codelineno-24-36">36</a></span>
<span class="normal"><a href="#__codelineno-24-37">37</a></span>
<span class="normal"><a href="#__codelineno-24-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="n">ERROR_CODES</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>    <span class="s2">&quot;PAYMENT_REQUIRED&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;PAYMENT_REQUIRED&quot;</span><span class="p">,</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment is required to access this resource&quot;</span><span class="p">,</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a>        <span class="s2">&quot;user_action&quot;</span><span class="p">:</span> <span class="s2">&quot;Ensure wallet has sufficient funds and retry&quot;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a>    <span class="p">},</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>    <span class="s2">&quot;PAYMENT_EXPIRED&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;PAYMENT_EXPIRED&quot;</span><span class="p">,</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment request has expired&quot;</span><span class="p">,</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a>        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a>        <span class="s2">&quot;user_action&quot;</span><span class="p">:</span> <span class="s2">&quot;Request a new payment authorization&quot;</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a>    <span class="p">},</span>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a>    <span class="s2">&quot;INSUFFICIENT_FUNDS&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;INSUFFICIENT_FUNDS&quot;</span><span class="p">,</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Wallet has insufficient token balance&quot;</span><span class="p">,</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a>        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>        <span class="s2">&quot;user_action&quot;</span><span class="p">:</span> <span class="s2">&quot;Add funds to wallet&quot;</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a>    <span class="p">},</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a>    <span class="s2">&quot;PAYMENT_VERIFICATION_FAILED&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;PAYMENT_VERIFICATION_FAILED&quot;</span><span class="p">,</span>
<a id="__codelineno-24-22" name="__codelineno-24-22"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Server could not verify payment&quot;</span><span class="p">,</span>
<a id="__codelineno-24-23" name="__codelineno-24-23"></a>        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-24-24" name="__codelineno-24-24"></a>        <span class="s2">&quot;user_action&quot;</span><span class="p">:</span> <span class="s2">&quot;Contact API provider if issue persists&quot;</span>
<a id="__codelineno-24-25" name="__codelineno-24-25"></a>    <span class="p">},</span>
<a id="__codelineno-24-26" name="__codelineno-24-26"></a>    <span class="s2">&quot;TRANSACTION_BROADCAST_FAILED&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-24-27" name="__codelineno-24-27"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;TRANSACTION_BROADCAST_FAILED&quot;</span><span class="p">,</span>
<a id="__codelineno-24-28" name="__codelineno-24-28"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to broadcast transaction to blockchain&quot;</span><span class="p">,</span>
<a id="__codelineno-24-29" name="__codelineno-24-29"></a>        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-24-30" name="__codelineno-24-30"></a>        <span class="s2">&quot;user_action&quot;</span><span class="p">:</span> <span class="s2">&quot;Check network connection and RPC endpoint&quot;</span>
<a id="__codelineno-24-31" name="__codelineno-24-31"></a>    <span class="p">},</span>
<a id="__codelineno-24-32" name="__codelineno-24-32"></a>    <span class="s2">&quot;INVALID_PAYMENT_REQUEST&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-24-33" name="__codelineno-24-33"></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;INVALID_PAYMENT_REQUEST&quot;</span><span class="p">,</span>
<a id="__codelineno-24-34" name="__codelineno-24-34"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Payment request format is invalid&quot;</span><span class="p">,</span>
<a id="__codelineno-24-35" name="__codelineno-24-35"></a>        <span class="s2">&quot;retry&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-24-36" name="__codelineno-24-36"></a>        <span class="s2">&quot;user_action&quot;</span><span class="p">:</span> <span class="s2">&quot;Contact API provider&quot;</span>
<a id="__codelineno-24-37" name="__codelineno-24-37"></a>    <span class="p">},</span>
<a id="__codelineno-24-38" name="__codelineno-24-38"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="7-testing-development">7. Testing &amp; Development<a class="headerlink" href="#7-testing-development" title="Permanent link">&para;</a></h2>
<h3 id="test-utilities">Test Utilities<a class="headerlink" href="#test-utilities" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span>
<span class="normal"><a href="#__codelineno-25-30">30</a></span>
<span class="normal"><a href="#__codelineno-25-31">31</a></span>
<span class="normal"><a href="#__codelineno-25-32">32</a></span>
<span class="normal"><a href="#__codelineno-25-33">33</a></span>
<span class="normal"><a href="#__codelineno-25-34">34</a></span>
<span class="normal"><a href="#__codelineno-25-35">35</a></span>
<span class="normal"><a href="#__codelineno-25-36">36</a></span>
<span class="normal"><a href="#__codelineno-25-37">37</a></span>
<span class="normal"><a href="#__codelineno-25-38">38</a></span>
<span class="normal"><a href="#__codelineno-25-39">39</a></span>
<span class="normal"><a href="#__codelineno-25-40">40</a></span>
<span class="normal"><a href="#__codelineno-25-41">41</a></span>
<span class="normal"><a href="#__codelineno-25-42">42</a></span>
<span class="normal"><a href="#__codelineno-25-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1"># In openlibx402-core</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">MockSolanaPaymentProcessor</span><span class="p">(</span><span class="n">SolanaPaymentProcessor</span><span class="p">):</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock processor for testing without real blockchain&quot;&quot;&quot;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># Mock balance</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_payment_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return mock transaction&quot;&quot;&quot;</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>        <span class="k">return</span> <span class="n">MockTransaction</span><span class="p">()</span>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sign_and_send_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return mock tx hash&quot;&quot;&quot;</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>        <span class="n">tx_hash</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mock_tx_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>        <span class="k">return</span> <span class="n">tx_hash</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Always verify successfully&quot;&quot;&quot;</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_token_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return mock balance&quot;&quot;&quot;</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestServer</span><span class="p">:</span>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock X402 server for testing&quot;&quot;&quot;</span>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token_mint</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_address</span> <span class="o">=</span> <span class="n">payment_address</span>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_mint</span> <span class="o">=</span> <span class="n">token_mint</span>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payments_received</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">require_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-25-38" name="__codelineno-25-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that adds payment requirement&quot;&quot;&quot;</span>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a>        <span class="k">pass</span>
<a id="__codelineno-25-40" name="__codelineno-25-40"></a>
<a id="__codelineno-25-41" name="__codelineno-25-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8402</span><span class="p">):</span>
<a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start test server&quot;&quot;&quot;</span>
<a id="__codelineno-25-43" name="__codelineno-25-43"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
<h3 id="example-test">Example Test<a class="headerlink" href="#example-test" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openlibx402_core.testing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockSolanaPaymentProcessor</span><span class="p">,</span> <span class="n">TestServer</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_payment_flow</span><span class="p">():</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complete payment flow&quot;&quot;&quot;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a>    <span class="c1"># Setup test server</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a>    <span class="n">server</span> <span class="o">=</span> <span class="n">TestServer</span><span class="p">(</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a>        <span class="n">payment_address</span><span class="o">=</span><span class="s2">&quot;mock_address&quot;</span><span class="p">,</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a>        <span class="n">token_mint</span><span class="o">=</span><span class="s2">&quot;mock_usdc&quot;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a>    <span class="p">)</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a>    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">8402</span><span class="p">)</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a>    <span class="c1"># Create client with mock processor</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a>    <span class="n">keypair</span> <span class="o">=</span> <span class="n">Keypair</span><span class="p">()</span>  <span class="c1"># Generate test keypair</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span><span class="n">wallet_keypair</span><span class="o">=</span><span class="n">keypair</span><span class="p">)</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a>    <span class="n">client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">processor</span> <span class="o">=</span> <span class="n">MockSolanaPaymentProcessor</span><span class="p">()</span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>    <span class="c1"># Make request to paywalled endpoint</span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;http://localhost:8402/premium-data&quot;</span><span class="p">)</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a>    <span class="c1"># Verify payment was made</span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a>    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">transactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a>    <span class="c1"># Cleanup</span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a>    <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="8-example-implementations">8. Example Implementations<a class="headerlink" href="#8-example-implementations" title="Permanent link">&para;</a></h2>
<h3 id="81-fastapi-server-example">8.1 FastAPI Server Example<a class="headerlink" href="#81-fastapi-server-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span>
<span class="normal"><a href="#__codelineno-27-35">35</a></span>
<span class="normal"><a href="#__codelineno-27-36">36</a></span>
<span class="normal"><a href="#__codelineno-27-37">37</a></span>
<span class="normal"><a href="#__codelineno-27-38">38</a></span>
<span class="normal"><a href="#__codelineno-27-39">39</a></span>
<span class="normal"><a href="#__codelineno-27-40">40</a></span>
<span class="normal"><a href="#__codelineno-27-41">41</a></span>
<span class="normal"><a href="#__codelineno-27-42">42</a></span>
<span class="normal"><a href="#__codelineno-27-43">43</a></span>
<span class="normal"><a href="#__codelineno-27-44">44</a></span>
<span class="normal"><a href="#__codelineno-27-45">45</a></span>
<span class="normal"><a href="#__codelineno-27-46">46</a></span>
<span class="normal"><a href="#__codelineno-27-47">47</a></span>
<span class="normal"><a href="#__codelineno-27-48">48</a></span>
<span class="normal"><a href="#__codelineno-27-49">49</a></span>
<span class="normal"><a href="#__codelineno-27-50">50</a></span>
<span class="normal"><a href="#__codelineno-27-51">51</a></span>
<span class="normal"><a href="#__codelineno-27-52">52</a></span>
<span class="normal"><a href="#__codelineno-27-53">53</a></span>
<span class="normal"><a href="#__codelineno-27-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1"># examples/fastapi-server/main.py</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openlibx402_fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">payment_required</span><span class="p">,</span> <span class="n">X402Config</span><span class="p">,</span> <span class="n">init_x402</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solders.keypair</span><span class="w"> </span><span class="kn">import</span> <span class="n">Keypair</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="c1"># Initialize X402</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="n">config</span> <span class="o">=</span> <span class="n">X402Config</span><span class="p">(</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a>    <span class="n">payment_address</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PAYMENT_WALLET_ADDRESS&quot;</span><span class="p">),</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a>    <span class="n">token_mint</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USDC_MINT_ADDRESS&quot;</span><span class="p">),</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>    <span class="n">network</span><span class="o">=</span><span class="s2">&quot;solana-devnet&quot;</span><span class="p">,</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="p">)</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="n">init_x402</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="c1"># Simple decorator approach</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/premium-data&quot;</span><span class="p">)</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="nd">@payment_required</span><span class="p">(</span>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>    <span class="n">amount</span><span class="o">=</span><span class="s2">&quot;0.10&quot;</span><span class="p">,</span>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a>    <span class="n">payment_address</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">payment_address</span><span class="p">,</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a>    <span class="n">token_mint</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">token_mint</span><span class="p">,</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Access to premium market data&quot;</span>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a><span class="p">)</span>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_premium_data</span><span class="p">():</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;This is premium content&quot;</span><span class="p">,</span>
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mf">100.50</span><span class="p">,</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-05-06T10:00:00Z&quot;</span>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>    <span class="p">}</span>
<a id="__codelineno-27-32" name="__codelineno-27-32"></a>
<a id="__codelineno-27-33" name="__codelineno-27-33"></a><span class="c1"># Dependency injection approach</span>
<a id="__codelineno-27-34" name="__codelineno-27-34"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openlibx402_fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">verify_payment_factory</span>
<a id="__codelineno-27-35" name="__codelineno-27-35"></a>
<a id="__codelineno-27-36" name="__codelineno-27-36"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/expensive-data&quot;</span><span class="p">)</span>
<a id="__codelineno-27-37" name="__codelineno-27-37"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_expensive_data</span><span class="p">(</span>
<a id="__codelineno-27-38" name="__codelineno-27-38"></a>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span>
<a id="__codelineno-27-39" name="__codelineno-27-39"></a>        <span class="n">verify_payment_factory</span><span class="p">(</span>
<a id="__codelineno-27-40" name="__codelineno-27-40"></a>            <span class="n">amount</span><span class="o">=</span><span class="s2">&quot;1.00&quot;</span><span class="p">,</span>
<a id="__codelineno-27-41" name="__codelineno-27-41"></a>            <span class="n">payment_address</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">payment_address</span><span class="p">,</span>
<a id="__codelineno-27-42" name="__codelineno-27-42"></a>            <span class="n">token_mint</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">token_mint</span><span class="p">,</span>
<a id="__codelineno-27-43" name="__codelineno-27-43"></a>        <span class="p">)</span>
<a id="__codelineno-27-44" name="__codelineno-27-44"></a>    <span class="p">)</span>
<a id="__codelineno-27-45" name="__codelineno-27-45"></a><span class="p">):</span>
<a id="__codelineno-27-46" name="__codelineno-27-46"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-27-47" name="__codelineno-27-47"></a>        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;Very expensive content&quot;</span><span class="p">,</span>
<a id="__codelineno-27-48" name="__codelineno-27-48"></a>        <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
<a id="__codelineno-27-49" name="__codelineno-27-49"></a>        <span class="s2">&quot;amount_paid&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">actual_amount</span><span class="p">,</span>
<a id="__codelineno-27-50" name="__codelineno-27-50"></a>    <span class="p">}</span>
<a id="__codelineno-27-51" name="__codelineno-27-51"></a>
<a id="__codelineno-27-52" name="__codelineno-27-52"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-27-53" name="__codelineno-27-53"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-27-54" name="__codelineno-27-54"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="82-langchain-agent-example">8.2 LangChain Agent Example<a class="headerlink" href="#82-langchain-agent-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span>
<span class="normal"><a href="#__codelineno-28-32">32</a></span>
<span class="normal"><a href="#__codelineno-28-33">33</a></span>
<span class="normal"><a href="#__codelineno-28-34">34</a></span>
<span class="normal"><a href="#__codelineno-28-35">35</a></span>
<span class="normal"><a href="#__codelineno-28-36">36</a></span>
<span class="normal"><a href="#__codelineno-28-37">37</a></span>
<span class="normal"><a href="#__codelineno-28-38">38</a></span>
<span class="normal"><a href="#__codelineno-28-39">39</a></span>
<span class="normal"><a href="#__codelineno-28-40">40</a></span>
<span class="normal"><a href="#__codelineno-28-41">41</a></span>
<span class="normal"><a href="#__codelineno-28-42">42</a></span>
<span class="normal"><a href="#__codelineno-28-43">43</a></span>
<span class="normal"><a href="#__codelineno-28-44">44</a></span>
<span class="normal"><a href="#__codelineno-28-45">45</a></span>
<span class="normal"><a href="#__codelineno-28-46">46</a></span>
<span class="normal"><a href="#__codelineno-28-47">47</a></span>
<span class="normal"><a href="#__codelineno-28-48">48</a></span>
<span class="normal"><a href="#__codelineno-28-49">49</a></span>
<span class="normal"><a href="#__codelineno-28-50">50</a></span>
<span class="normal"><a href="#__codelineno-28-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="c1"># examples/langchain-agent/main.py</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_agent</span><span class="p">,</span> <span class="n">AgentType</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openlibx402_langchain</span><span class="w"> </span><span class="kn">import</span> <span class="n">X402PaymentTool</span><span class="p">,</span> <span class="n">X402RequestsWrapper</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solders.keypair</span><span class="w"> </span><span class="kn">import</span> <span class="n">Keypair</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="c1"># Load wallet</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;wallet.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a>    <span class="n">wallet_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>    <span class="n">keypair</span> <span class="o">=</span> <span class="n">Keypair</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">wallet_data</span><span class="p">))</span>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="c1"># Create X402-enabled tools</span>
<a id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="n">payment_tool</span> <span class="o">=</span> <span class="n">X402PaymentTool</span><span class="p">(</span>
<a id="__codelineno-28-17" name="__codelineno-28-17"></a>    <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">keypair</span><span class="p">,</span>
<a id="__codelineno-28-18" name="__codelineno-28-18"></a>    <span class="n">max_payment</span><span class="o">=</span><span class="s2">&quot;5.0&quot;</span><span class="p">,</span>
<a id="__codelineno-28-19" name="__codelineno-28-19"></a>    <span class="n">rpc_url</span><span class="o">=</span><span class="s2">&quot;https://api.devnet.solana.com&quot;</span>
<a id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="p">)</span>
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="c1"># Create requests wrapper for automatic payment handling</span>
<a id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="n">requests_wrapper</span> <span class="o">=</span> <span class="n">X402RequestsWrapper</span><span class="p">(</span>
<a id="__codelineno-28-24" name="__codelineno-28-24"></a>    <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">keypair</span><span class="p">,</span>
<a id="__codelineno-28-25" name="__codelineno-28-25"></a>    <span class="n">max_payment</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>
<a id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="p">)</span>
<a id="__codelineno-28-27" name="__codelineno-28-27"></a>
<a id="__codelineno-28-28" name="__codelineno-28-28"></a><span class="c1"># Load LangChain tools with X402 support</span>
<a id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_tools</span>
<a id="__codelineno-28-30" name="__codelineno-28-30"></a><span class="n">tools</span> <span class="o">=</span> <span class="n">load_tools</span><span class="p">(</span>
<a id="__codelineno-28-31" name="__codelineno-28-31"></a>    <span class="p">[</span><span class="s2">&quot;requests_all&quot;</span><span class="p">],</span>
<a id="__codelineno-28-32" name="__codelineno-28-32"></a>    <span class="n">llm</span><span class="o">=</span><span class="n">ChatOpenAI</span><span class="p">(),</span>
<a id="__codelineno-28-33" name="__codelineno-28-33"></a>    <span class="n">requests_wrapper</span><span class="o">=</span><span class="n">requests_wrapper</span>
<a id="__codelineno-28-34" name="__codelineno-28-34"></a><span class="p">)</span>
<a id="__codelineno-28-35" name="__codelineno-28-35"></a><span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payment_tool</span><span class="p">)</span>
<a id="__codelineno-28-36" name="__codelineno-28-36"></a>
<a id="__codelineno-28-37" name="__codelineno-28-37"></a><span class="c1"># Create agent</span>
<a id="__codelineno-28-38" name="__codelineno-28-38"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span>
<a id="__codelineno-28-39" name="__codelineno-28-39"></a>    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
<a id="__codelineno-28-40" name="__codelineno-28-40"></a>    <span class="n">llm</span><span class="o">=</span><span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-28-41" name="__codelineno-28-41"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">AgentType</span><span class="o">.</span><span class="n">ZERO_SHOT_REACT_DESCRIPTION</span><span class="p">,</span>
<a id="__codelineno-28-42" name="__codelineno-28-42"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-28-43" name="__codelineno-28-43"></a><span class="p">)</span>
<a id="__codelineno-28-44" name="__codelineno-28-44"></a>
<a id="__codelineno-28-45" name="__codelineno-28-45"></a><span class="c1"># Run agent</span>
<a id="__codelineno-28-46" name="__codelineno-28-46"></a><span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-28-47" name="__codelineno-28-47"></a>    <span class="s2">&quot;Get me the premium market data from http://localhost:8000/premium-data &quot;</span>
<a id="__codelineno-28-48" name="__codelineno-28-48"></a>    <span class="s2">&quot;and tell me the current price&quot;</span>
<a id="__codelineno-28-49" name="__codelineno-28-49"></a><span class="p">)</span>
<a id="__codelineno-28-50" name="__codelineno-28-50"></a>
<a id="__codelineno-28-51" name="__codelineno-28-51"></a><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="83-langgraph-workflow-example">8.3 LangGraph Workflow Example<a class="headerlink" href="#83-langgraph-workflow-example" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span>
<span class="normal"><a href="#__codelineno-29-23">23</a></span>
<span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span>
<span class="normal"><a href="#__codelineno-29-30">30</a></span>
<span class="normal"><a href="#__codelineno-29-31">31</a></span>
<span class="normal"><a href="#__codelineno-29-32">32</a></span>
<span class="normal"><a href="#__codelineno-29-33">33</a></span>
<span class="normal"><a href="#__codelineno-29-34">34</a></span>
<span class="normal"><a href="#__codelineno-29-35">35</a></span>
<span class="normal"><a href="#__codelineno-29-36">36</a></span>
<span class="normal"><a href="#__codelineno-29-37">37</a></span>
<span class="normal"><a href="#__codelineno-29-38">38</a></span>
<span class="normal"><a href="#__codelineno-29-39">39</a></span>
<span class="normal"><a href="#__codelineno-29-40">40</a></span>
<span class="normal"><a href="#__codelineno-29-41">41</a></span>
<span class="normal"><a href="#__codelineno-29-42">42</a></span>
<span class="normal"><a href="#__codelineno-29-43">43</a></span>
<span class="normal"><a href="#__codelineno-29-44">44</a></span>
<span class="normal"><a href="#__codelineno-29-45">45</a></span>
<span class="normal"><a href="#__codelineno-29-46">46</a></span>
<span class="normal"><a href="#__codelineno-29-47">47</a></span>
<span class="normal"><a href="#__codelineno-29-48">48</a></span>
<span class="normal"><a href="#__codelineno-29-49">49</a></span>
<span class="normal"><a href="#__codelineno-29-50">50</a></span>
<span class="normal"><a href="#__codelineno-29-51">51</a></span>
<span class="normal"><a href="#__codelineno-29-52">52</a></span>
<span class="normal"><a href="#__codelineno-29-53">53</a></span>
<span class="normal"><a href="#__codelineno-29-54">54</a></span>
<span class="normal"><a href="#__codelineno-29-55">55</a></span>
<span class="normal"><a href="#__codelineno-29-56">56</a></span>
<span class="normal"><a href="#__codelineno-29-57">57</a></span>
<span class="normal"><a href="#__codelineno-29-58">58</a></span>
<span class="normal"><a href="#__codelineno-29-59">59</a></span>
<span class="normal"><a href="#__codelineno-29-60">60</a></span>
<span class="normal"><a href="#__codelineno-29-61">61</a></span>
<span class="normal"><a href="#__codelineno-29-62">62</a></span>
<span class="normal"><a href="#__codelineno-29-63">63</a></span>
<span class="normal"><a href="#__codelineno-29-64">64</a></span>
<span class="normal"><a href="#__codelineno-29-65">65</a></span>
<span class="normal"><a href="#__codelineno-29-66">66</a></span>
<span class="normal"><a href="#__codelineno-29-67">67</a></span>
<span class="normal"><a href="#__codelineno-29-68">68</a></span>
<span class="normal"><a href="#__codelineno-29-69">69</a></span>
<span class="normal"><a href="#__codelineno-29-70">70</a></span>
<span class="normal"><a href="#__codelineno-29-71">71</a></span>
<span class="normal"><a href="#__codelineno-29-72">72</a></span>
<span class="normal"><a href="#__codelineno-29-73">73</a></span>
<span class="normal"><a href="#__codelineno-29-74">74</a></span>
<span class="normal"><a href="#__codelineno-29-75">75</a></span>
<span class="normal"><a href="#__codelineno-29-76">76</a></span>
<span class="normal"><a href="#__codelineno-29-77">77</a></span>
<span class="normal"><a href="#__codelineno-29-78">78</a></span>
<span class="normal"><a href="#__codelineno-29-79">79</a></span>
<span class="normal"><a href="#__codelineno-29-80">80</a></span>
<span class="normal"><a href="#__codelineno-29-81">81</a></span>
<span class="normal"><a href="#__codelineno-29-82">82</a></span>
<span class="normal"><a href="#__codelineno-29-83">83</a></span>
<span class="normal"><a href="#__codelineno-29-84">84</a></span>
<span class="normal"><a href="#__codelineno-29-85">85</a></span>
<span class="normal"><a href="#__codelineno-29-86">86</a></span>
<span class="normal"><a href="#__codelineno-29-87">87</a></span>
<span class="normal"><a href="#__codelineno-29-88">88</a></span>
<span class="normal"><a href="#__codelineno-29-89">89</a></span>
<span class="normal"><a href="#__codelineno-29-90">90</a></span>
<span class="normal"><a href="#__codelineno-29-91">91</a></span>
<span class="normal"><a href="#__codelineno-29-92">92</a></span>
<span class="normal"><a href="#__codelineno-29-93">93</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="c1"># examples/langgraph-workflow/main.py</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openlibx402_langgraph</span><span class="w"> </span><span class="kn">import</span> <span class="n">payment_node</span><span class="p">,</span> <span class="n">check_payment_required</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">openlibx402_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">X402AutoClient</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">solders.keypair</span><span class="w"> </span><span class="kn">import</span> <span class="n">Keypair</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="c1"># Define state</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResearchState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a>    <span class="n">api_url</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a>    <span class="n">api_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a>    <span class="n">payment_required</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a>    <span class="n">payment_completed</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a>    <span class="n">payment_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a>    <span class="n">wallet_keypair</span><span class="p">:</span> <span class="n">Keypair</span>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a>    <span class="n">final_answer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="c1"># Load wallet</span>
<a id="__codelineno-29-23" name="__codelineno-29-23"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;wallet.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-29-24" name="__codelineno-29-24"></a>    <span class="n">wallet_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-29-25" name="__codelineno-29-25"></a>    <span class="n">keypair</span> <span class="o">=</span> <span class="n">Keypair</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">wallet_data</span><span class="p">))</span>
<a id="__codelineno-29-26" name="__codelineno-29-26"></a>
<a id="__codelineno-29-27" name="__codelineno-29-27"></a><span class="c1"># Define nodes</span>
<a id="__codelineno-29-28" name="__codelineno-29-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">plan_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResearchState</span><span class="p">:</span>
<a id="__codelineno-29-29" name="__codelineno-29-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine which API to call&quot;&quot;&quot;</span>
<a id="__codelineno-29-30" name="__codelineno-29-30"></a>    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:8000/premium-data&quot;</span>
<a id="__codelineno-29-31" name="__codelineno-29-31"></a>    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-29-32" name="__codelineno-29-32"></a>    <span class="k">return</span> <span class="n">state</span>
<a id="__codelineno-29-33" name="__codelineno-29-33"></a>
<a id="__codelineno-29-34" name="__codelineno-29-34"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_api_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResearchState</span><span class="p">:</span>
<a id="__codelineno-29-35" name="__codelineno-29-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch from API&quot;&quot;&quot;</span>
<a id="__codelineno-29-36" name="__codelineno-29-36"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">X402AutoClient</span><span class="p">(</span>
<a id="__codelineno-29-37" name="__codelineno-29-37"></a>        <span class="n">wallet_keypair</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;wallet_keypair&quot;</span><span class="p">],</span>
<a id="__codelineno-29-38" name="__codelineno-29-38"></a>        <span class="n">auto_retry</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># We&#39;ll handle retry via graph</span>
<a id="__codelineno-29-39" name="__codelineno-29-39"></a>    <span class="p">)</span>
<a id="__codelineno-29-40" name="__codelineno-29-40"></a>
<a id="__codelineno-29-41" name="__codelineno-29-41"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-29-42" name="__codelineno-29-42"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">])</span>
<a id="__codelineno-29-43" name="__codelineno-29-43"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-29-44" name="__codelineno-29-44"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-29-45" name="__codelineno-29-45"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-29-46" name="__codelineno-29-46"></a>        <span class="k">if</span> <span class="s2">&quot;402&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<a id="__codelineno-29-47" name="__codelineno-29-47"></a>            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-29-48" name="__codelineno-29-48"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-29-49" name="__codelineno-29-49"></a>            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;payment_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-29-50" name="__codelineno-29-50"></a>
<a id="__codelineno-29-51" name="__codelineno-29-51"></a>    <span class="k">return</span> <span class="n">state</span>
<a id="__codelineno-29-52" name="__codelineno-29-52"></a>
<a id="__codelineno-29-53" name="__codelineno-29-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResearchState</span><span class="p">:</span>
<a id="__codelineno-29-54" name="__codelineno-29-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Process API response&quot;&quot;&quot;</span>
<a id="__codelineno-29-55" name="__codelineno-29-55"></a>    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;api_response&quot;</span><span class="p">]:</span>
<a id="__codelineno-29-56" name="__codelineno-29-56"></a>        <span class="c1"># Parse and format response</span>
<a id="__codelineno-29-57" name="__codelineno-29-57"></a>        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;final_answer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Retrieved data: </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;api_response&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-29-58" name="__codelineno-29-58"></a>    <span class="k">return</span> <span class="n">state</span>
<a id="__codelineno-29-59" name="__codelineno-29-59"></a>
<a id="__codelineno-29-60" name="__codelineno-29-60"></a><span class="c1"># Build workflow</span>
<a id="__codelineno-29-61" name="__codelineno-29-61"></a><span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ResearchState</span><span class="p">)</span>
<a id="__codelineno-29-62" name="__codelineno-29-62"></a>
<a id="__codelineno-29-63" name="__codelineno-29-63"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="n">plan_node</span><span class="p">)</span>
<a id="__codelineno-29-64" name="__codelineno-29-64"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;fetch&quot;</span><span class="p">,</span> <span class="n">fetch_api_node</span><span class="p">)</span>
<a id="__codelineno-29-65" name="__codelineno-29-65"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;payment&quot;</span><span class="p">,</span> <span class="n">payment_node</span><span class="p">)</span>  <span class="c1"># From openlibx402-langgraph</span>
<a id="__codelineno-29-66" name="__codelineno-29-66"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">process_node</span><span class="p">)</span>
<a id="__codelineno-29-67" name="__codelineno-29-67"></a>
<a id="__codelineno-29-68" name="__codelineno-29-68"></a><span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span>
<a id="__codelineno-29-69" name="__codelineno-29-69"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="s2">&quot;fetch&quot;</span><span class="p">)</span>
<a id="__codelineno-29-70" name="__codelineno-29-70"></a>
<a id="__codelineno-29-71" name="__codelineno-29-71"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
<a id="__codelineno-29-72" name="__codelineno-29-72"></a>    <span class="s2">&quot;fetch&quot;</span><span class="p">,</span>
<a id="__codelineno-29-73" name="__codelineno-29-73"></a>    <span class="n">check_payment_required</span><span class="p">,</span>  <span class="c1"># From openlibx402-langgraph</span>
<a id="__codelineno-29-74" name="__codelineno-29-74"></a>    <span class="p">{</span>
<a id="__codelineno-29-75" name="__codelineno-29-75"></a>        <span class="s2">&quot;payment_required&quot;</span><span class="p">:</span> <span class="s2">&quot;payment&quot;</span><span class="p">,</span>
<a id="__codelineno-29-76" name="__codelineno-29-76"></a>        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="s2">&quot;process&quot;</span><span class="p">,</span>
<a id="__codelineno-29-77" name="__codelineno-29-77"></a>        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">END</span>
<a id="__codelineno-29-78" name="__codelineno-29-78"></a>    <span class="p">}</span>
<a id="__codelineno-29-79" name="__codelineno-29-79"></a><span class="p">)</span>
<a id="__codelineno-29-80" name="__codelineno-29-80"></a>
<a id="__codelineno-29-81" name="__codelineno-29-81"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;payment&quot;</span><span class="p">,</span> <span class="s2">&quot;fetch&quot;</span><span class="p">)</span>  <span class="c1"># Retry after payment</span>
<a id="__codelineno-29-82" name="__codelineno-29-82"></a><span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<a id="__codelineno-29-83" name="__codelineno-29-83"></a>
<a id="__codelineno-29-84" name="__codelineno-29-84"></a><span class="c1"># Compile and run</span>
<a id="__codelineno-29-85" name="__codelineno-29-85"></a><span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
<a id="__codelineno-29-86" name="__codelineno-29-86"></a>
<a id="__codelineno-29-87" name="__codelineno-29-87"></a><span class="c1"># Execute</span>
<a id="__codelineno-29-88" name="__codelineno-29-88"></a><span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span>
<a id="__codelineno-29-89" name="__codelineno-29-89"></a>    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;Get premium market data&quot;</span><span class="p">,</span>
<a id="__codelineno-29-90" name="__codelineno-29-90"></a>    <span class="s2">&quot;wallet_keypair&quot;</span><span class="p">:</span> <span class="n">keypair</span><span class="p">,</span>
<a id="__codelineno-29-91" name="__codelineno-29-91"></a><span class="p">})</span>
<a id="__codelineno-29-92" name="__codelineno-29-92"></a>
<a id="__codelineno-29-93" name="__codelineno-29-93"></a><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;final_answer&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="9-package-metadata-publishing">9. Package Metadata &amp; Publishing<a class="headerlink" href="#9-package-metadata-publishing" title="Permanent link">&para;</a></h2>
<h3 id="python-packages-pypi">Python Packages (PyPI)<a class="headerlink" href="#python-packages-pypi" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span>
<span class="normal"><a href="#__codelineno-30-24">24</a></span>
<span class="normal"><a href="#__codelineno-30-25">25</a></span>
<span class="normal"><a href="#__codelineno-30-26">26</a></span>
<span class="normal"><a href="#__codelineno-30-27">27</a></span>
<span class="normal"><a href="#__codelineno-30-28">28</a></span>
<span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1"># pyproject.toml example for openlibx402-core</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="k">[build-system]</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="n">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;hatchling&quot;</span><span class="p">]</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="n">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hatchling.build&quot;</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="k">[project]</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;openlibx402-core&quot;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Core implementation of X402 payment protocol&quot;</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="p">{</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;OpenLibx402 Contributors&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;hello@openlibx402.org&quot;</span><span class="p">},</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="p">]</span>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="n">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;README.md&quot;</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="n">license</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">text</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;MIT&quot;</span><span class="p">}</span>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.8&quot;</span>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="w">    </span><span class="s2">&quot;solana&gt;=0.30.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="w">    </span><span class="s2">&quot;solders&gt;=0.18.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="w">    </span><span class="s2">&quot;httpx&gt;=0.24.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">    </span><span class="s2">&quot;pydantic&gt;=2.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="p">]</span>
<a id="__codelineno-30-23" name="__codelineno-30-23"></a>
<a id="__codelineno-30-24" name="__codelineno-30-24"></a><span class="k">[project.optional-dependencies]</span>
<a id="__codelineno-30-25" name="__codelineno-30-25"></a><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-30-26" name="__codelineno-30-26"></a><span class="w">    </span><span class="s2">&quot;pytest&gt;=7.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-27" name="__codelineno-30-27"></a><span class="w">    </span><span class="s2">&quot;pytest-asyncio&gt;=0.21.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-28" name="__codelineno-30-28"></a><span class="w">    </span><span class="s2">&quot;black&gt;=23.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-29" name="__codelineno-30-29"></a><span class="w">    </span><span class="s2">&quot;mypy&gt;=1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-30-30" name="__codelineno-30-30"></a><span class="p">]</span>
<a id="__codelineno-30-31" name="__codelineno-30-31"></a>
<a id="__codelineno-30-32" name="__codelineno-30-32"></a><span class="k">[project.urls]</span>
<a id="__codelineno-30-33" name="__codelineno-30-33"></a><span class="n">Homepage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/openlibx402/openlibx402&quot;</span>
<a id="__codelineno-30-34" name="__codelineno-30-34"></a><span class="n">Documentation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://docs.openlibx402.org&quot;</span>
<a id="__codelineno-30-35" name="__codelineno-30-35"></a><span class="n">Repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/openlibx402/openlibx402&quot;</span>
</code></pre></div></td></tr></table></div>
<h3 id="typescript-packages-npm">TypeScript Packages (npm)<a class="headerlink" href="#typescript-packages-npm" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="c1">// package.json example for @openlibx402/core</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="p">{</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;@openlibx402/core&quot;</span><span class="p">,</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Core implementation of X402 payment protocol&quot;</span><span class="p">,</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dist/index.js&quot;</span><span class="p">,</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">  </span><span class="nt">&quot;types&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dist/index.d.ts&quot;</span><span class="p">,</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tsc&quot;</span><span class="p">,</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="w">    </span><span class="nt">&quot;test&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jest&quot;</span><span class="p">,</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="w">    </span><span class="nt">&quot;lint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eslint src/**/*.ts&quot;</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">  </span><span class="nt">&quot;keywords&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;x402&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;payments&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;solana&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ai-agents&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;web3&quot;</span><span class="p">],</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OpenLibx402 Contributors&quot;</span><span class="p">,</span>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="w">    </span><span class="nt">&quot;@solana/web3.js&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^1.87.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">    </span><span class="nt">&quot;@solana/spl-token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^0.3.9&quot;</span><span class="p">,</span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">    </span><span class="nt">&quot;axios&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^1.6.0&quot;</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-31-22" name="__codelineno-31-22"></a><span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-23" name="__codelineno-31-23"></a><span class="w">    </span><span class="nt">&quot;@types/node&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^20.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-24" name="__codelineno-31-24"></a><span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-25" name="__codelineno-31-25"></a><span class="w">    </span><span class="nt">&quot;jest&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^29.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-31-26" name="__codelineno-31-26"></a><span class="w">    </span><span class="nt">&quot;eslint&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^8.0.0&quot;</span>
<a id="__codelineno-31-27" name="__codelineno-31-27"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-31-28" name="__codelineno-31-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="10-documentation-structure">10. Documentation Structure<a class="headerlink" href="#10-documentation-structure" title="Permanent link">&para;</a></h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span>
<span class="normal"><a href="#__codelineno-32-19">19</a></span>
<span class="normal"><a href="#__codelineno-32-20">20</a></span>
<span class="normal"><a href="#__codelineno-32-21">21</a></span>
<span class="normal"><a href="#__codelineno-32-22">22</a></span>
<span class="normal"><a href="#__codelineno-32-23">23</a></span>
<span class="normal"><a href="#__codelineno-32-24">24</a></span>
<span class="normal"><a href="#__codelineno-32-25">25</a></span>
<span class="normal"><a href="#__codelineno-32-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>docs/
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>├── getting-started/
<a id="__codelineno-32-3" name="__codelineno-32-3"></a>│   ├── installation.md
<a id="__codelineno-32-4" name="__codelineno-32-4"></a>│   ├── quickstart-server.md
<a id="__codelineno-32-5" name="__codelineno-32-5"></a>│   ├── quickstart-client.md
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>│   └── quickstart-agent.md
<a id="__codelineno-32-7" name="__codelineno-32-7"></a>├── guides/
<a id="__codelineno-32-8" name="__codelineno-32-8"></a>│   ├── fastapi-integration.md
<a id="__codelineno-32-9" name="__codelineno-32-9"></a>│   ├── langchain-integration.md
<a id="__codelineno-32-10" name="__codelineno-32-10"></a>│   ├── langgraph-integration.md
<a id="__codelineno-32-11" name="__codelineno-32-11"></a>│   ├── wallet-setup.md
<a id="__codelineno-32-12" name="__codelineno-32-12"></a>│   └── testing-locally.md
<a id="__codelineno-32-13" name="__codelineno-32-13"></a>├── api-reference/
<a id="__codelineno-32-14" name="__codelineno-32-14"></a>│   ├── core/
<a id="__codelineno-32-15" name="__codelineno-32-15"></a>│   ├── server/
<a id="__codelineno-32-16" name="__codelineno-32-16"></a>│   ├── client/
<a id="__codelineno-32-17" name="__codelineno-32-17"></a>│   └── integrations/
<a id="__codelineno-32-18" name="__codelineno-32-18"></a>├── examples/
<a id="__codelineno-32-19" name="__codelineno-32-19"></a>│   ├── basic-api-server.md
<a id="__codelineno-32-20" name="__codelineno-32-20"></a>│   ├── autonomous-agent.md
<a id="__codelineno-32-21" name="__codelineno-32-21"></a>│   ├── multi-agent-workflow.md
<a id="__codelineno-32-22" name="__codelineno-32-22"></a>│   └── error-handling.md
<a id="__codelineno-32-23" name="__codelineno-32-23"></a>└── advanced/
<a id="__codelineno-32-24" name="__codelineno-32-24"></a>    ├── custom-settlement.md
<a id="__codelineno-32-25" name="__codelineno-32-25"></a>    ├── performance-optimization.md
<a id="__codelineno-32-26" name="__codelineno-32-26"></a>    └── security-best-practices.md
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="11-development-roadmap">11. Development Roadmap<a class="headerlink" href="#11-development-roadmap" title="Permanent link">&para;</a></h2>
<h3 id="phase-1-core-fastapi">Phase 1: Core &amp; FastAPI<a class="headerlink" href="#phase-1-core-fastapi" title="Permanent link">&para;</a></h3>
<ul>
<li>✅ Core protocol implementation (Python + TypeScript)</li>
<li>✅ Solana blockchain integration</li>
<li>✅ FastAPI server middleware</li>
<li>✅ Basic client (explicit &amp; implicit)</li>
<li>✅ Error handling</li>
<li>✅ Testing utilities</li>
<li>✅ Example implementations</li>
</ul>
<h3 id="phase-2-ai-agent-integrations">Phase 2: AI Agent Integrations<a class="headerlink" href="#phase-2-ai-agent-integrations" title="Permanent link">&para;</a></h3>
<ul>
<li>✅ LangChain tool &amp; middleware</li>
<li>✅ LangGraph nodes &amp; helpers</li>
<li>🔲 Additional agent framework support (AutoGPT, CrewAI)</li>
</ul>
<h3 id="phase-3-additional-frameworks">Phase 3: Additional Frameworks<a class="headerlink" href="#phase-3-additional-frameworks" title="Permanent link">&para;</a></h3>
<ul>
<li>🔲 Express.js middleware (TypeScript)</li>
<li>🔲 Next.js API routes helper</li>
<li>🔲 Flask middleware (Python)</li>
<li>🔲 Django middleware (Python)</li>
<li>🔲 Hono middleware (TypeScript)</li>
</ul>
<h3 id="phase-4-enhanced-features">Phase 4: Enhanced Features<a class="headerlink" href="#phase-4-enhanced-features" title="Permanent link">&para;</a></h3>
<ul>
<li>🔲 Payment batching</li>
<li>🔲 Subscription management</li>
<li>🔲 Usage analytics</li>
<li>🔲 Multi-chain support (Ethereum, Base L2)</li>
<li>🔲 Alternative tokens (beyond USDC)</li>
</ul>
<h3 id="phase-5-ecosystem">Phase 5: Ecosystem<a class="headerlink" href="#phase-5-ecosystem" title="Permanent link">&para;</a></h3>
<ul>
<li>🔲 CLI tools</li>
<li>🔲 Admin dashboard</li>
<li>🔲 Wallet UI components</li>
<li>🔲 Browser extension</li>
<li>🔲 Zapier/Make.com integrations</li>
</ul>
<hr />
<h2 id="12-security-considerations">12. Security Considerations<a class="headerlink" href="#12-security-considerations" title="Permanent link">&para;</a></h2>
<h3 id="wallet-security">Wallet Security<a class="headerlink" href="#wallet-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Never log private keys</li>
<li>Use environment variables for sensitive data</li>
<li>Recommend hardware wallets for production</li>
<li>Implement rate limiting on payment endpoints</li>
</ul>
<h3 id="transaction-verification">Transaction Verification<a class="headerlink" href="#transaction-verification" title="Permanent link">&para;</a></h3>
<ul>
<li>Always verify transactions on-chain</li>
<li>Check recipient, amount, and token mint</li>
<li>Implement replay attack protection via nonce</li>
<li>Set reasonable expiration times (5-10 minutes)</li>
</ul>
<h3 id="api-security">API Security<a class="headerlink" href="#api-security" title="Permanent link">&para;</a></h3>
<ul>
<li>Implement CORS properly</li>
<li>Use HTTPS in production</li>
<li>Rate limit payment requests</li>
<li>Validate all payment authorization fields</li>
</ul>
<hr />
<h2 id="13-performance-optimization">13. Performance Optimization<a class="headerlink" href="#13-performance-optimization" title="Permanent link">&para;</a></h2>
<h3 id="client-side">Client-Side<a class="headerlink" href="#client-side" title="Permanent link">&para;</a></h3>
<ul>
<li>Reuse HTTP connections (connection pooling)</li>
<li>Cache payment authorizations (with expiry)</li>
<li>Batch multiple API calls where possible</li>
<li>Use WebSocket for high-frequency payments</li>
</ul>
<h3 id="server-side">Server-Side<a class="headerlink" href="#server-side" title="Permanent link">&para;</a></h3>
<ul>
<li>Async transaction verification</li>
<li>Cache verified payments (Redis)</li>
<li>Background transaction confirmation</li>
<li>Load balancing for RPC calls</li>
</ul>
<hr />
<h2 id="14-monitoring-observability">14. Monitoring &amp; Observability<a class="headerlink" href="#14-monitoring-observability" title="Permanent link">&para;</a></h2>
<h3 id="metrics-to-track">Metrics to Track<a class="headerlink" href="#metrics-to-track" title="Permanent link">&para;</a></h3>
<ul>
<li>Payment success rate</li>
<li>Transaction confirmation time</li>
<li>RPC endpoint latency</li>
<li>Token balance (for auto-replenishment alerts)</li>
<li>Error rates by type</li>
</ul>
<h3 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;openlibx402&quot;</span><span class="p">)</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="c1"># Log payment requests</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment required: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="c1"># Log successful payments</span>
<a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment verified: tx_hash=</span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="c1"># Log errors with context</span>
<a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-33-13" name="__codelineno-33-13"></a>    <span class="sa">f</span><span class="s2">&quot;Payment failed: </span><span class="si">{</span><span class="n">error_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-33-14" name="__codelineno-33-14"></a>    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-33-15" name="__codelineno-33-15"></a>        <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment_id</span><span class="p">,</span>
<a id="__codelineno-33-16" name="__codelineno-33-16"></a>        <span class="s2">&quot;wallet&quot;</span><span class="p">:</span> <span class="n">wallet_address</span><span class="p">,</span>
<a id="__codelineno-33-17" name="__codelineno-33-17"></a>        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-33-18" name="__codelineno-33-18"></a>    <span class="p">}</span>
<a id="__codelineno-33-19" name="__codelineno-33-19"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<hr />
<h2 id="end-of-technical-specification">End of Technical Specification<a class="headerlink" href="#end-of-technical-specification" title="Permanent link">&para;</a></h2>
<p>This specification provides a comprehensive blueprint for implementing the OpenLibx402 library ecosystem. The architecture is modular, allowing for incremental development and easy addition of new framework integrations.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/openlibx402" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.top", "navigation.tabs", "content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>